# æµæ°´çº¿

[ ](https://github.com/cnych/qikqiak.com/edit/master/docs/devops/tekton/pipeline.md "ç¼–è¾‘æ­¤é¡µ")

# æµæ°´çº¿

å‰é¢æˆ‘ä»¬çš„ä¸¤ä¸ªä»»åŠ¡ `test` å’Œ `build-and-push` éƒ½å·²ç»å®Œæˆäº†ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ›å»ºä¸€ä¸ªæµæ°´çº¿æ¥å°†è¿™ä¸¤ä¸ªä»»åŠ¡ç»„ç»‡èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªæµæ°´çº¿ï¼Œè¿™é‡Œå°±æ˜¯æˆ‘ä»¬è¦ä½¿ç”¨çš„ Pipeline è¿™ä¸ª CRD å¯¹è±¡ã€‚

## åˆ›å»ºæµæ°´çº¿

æ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„æµæ°´çº¿æµç¨‹ä¸ºå…ˆè¿è¡Œ test ä»»åŠ¡ï¼Œå¦‚æœé€šè¿‡äº†å†æ‰§è¡Œåé¢çš„ build-and-push è¿™ä¸ªä»»åŠ¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªåä¸º `test-pipeline.yaml` çš„èµ„æºå¯¹è±¡ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š
    
    
    # test-pipeline.yaml
    apiVersion: tekton.dev/v1beta1
    kind: Pipeline
    metadata:
      name: test-pipeline
    spec:
      resources: # ä¸º Tasks æä¾›è¾“å…¥å’Œè¾“å‡ºèµ„æºå£°æ˜
        - name: git-res
          type: git
        - name: harbor-image
          type: image
      tasks: # æ·»åŠ taskåˆ°æµæ°´çº¿ä¸­
        # è¿è¡Œåº”ç”¨æµ‹è¯•
        - name: test
          taskRef:
            name: test
          resources:
            inputs:
              - name: repo # Task è¾“å…¥åç§°
                resource: git-res # Pipeline èµ„æºåç§°
        # æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        - name: build-and-push
          taskRef:
            name: build-and-push
          runAfter:
            - test # æµ‹è¯•ä»»åŠ¡æ‰§è¡Œä¹‹å
          resources:
            inputs:
              - name: repo # æŒ‡å®šè¾“å…¥çš„gitä»“åº“èµ„æº
                resource: git-res
            outputs: # æŒ‡å®šè¾“å‡ºçš„é•œåƒèµ„æº
              - name: builtImage
                resource: harbor-image
    

é¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰æµæ°´çº¿éœ€è¦å“ªäº›èµ„æºï¼Œå¯ä»¥æ˜¯è¾“å…¥æˆ–è€…è¾“å‡ºçš„èµ„æºï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªè¾“å…¥ï¼Œé‚£å°±æ˜¯å‘½åä¸º repo çš„åº”ç”¨ç¨‹åºæºç çš„ GitHub ä»“åº“ã€‚æ¥ä¸‹æ¥å®šä¹‰ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½é€šè¿‡ `taskRef` è¿›è¡Œå¼•ç”¨ï¼Œå¹¶ä¼ é€’ä»»åŠ¡éœ€è¦çš„è¾“å…¥å‚æ•°ã€‚

åŒæ ·ç›´æ¥åˆ›å»ºè¿™ä¸ªèµ„æºå¯¹è±¡å³å¯ï¼š
    
    
    $ kubectl apply -f test-pipeline.yaml
    pipeline.tekton.dev/test-pipeline created
    

å‰é¢æˆ‘ä»¬æåˆ°è¿‡å’Œé€šè¿‡åˆ›å»º TaskRun å»è§¦å‘ Task ä»»åŠ¡ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª `PipelineRun` å¯¹è±¡æ¥è¿è¡Œæµæ°´çº¿ã€‚è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º `test-pipelinerun.yaml` çš„ `PipelineRun` å¯¹è±¡æ¥è¿è¡Œæµæ°´çº¿ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š
    
    
    # test-pipelinerun.yaml
    apiVersion: tekton.dev/v1beta1
    kind: PipelineRun
    metadata:
      name: test-pipelinerun
    spec:
      serviceAccountName: build-sa # å…³è”å¸¦æœ‰è®¤è¯ä¿¡æ¯çš„ ServiceAccount
      pipelineRef:
        name: test-pipeline
      resources:
        - name: git-res # æŒ‡å®šè¾“å…¥çš„gitä»“åº“èµ„æº
          resourceRef:
            name: git-res
        - name: harbor-image # æŒ‡å®šè¾“å‡ºçš„é•œåƒèµ„æº
          resourceRef:
            name: harbor-image
    

å®šä¹‰æ–¹å¼å’Œ TaskRun å‡ ä¹ä¸€æ ·ï¼Œé€šè¿‡ `serviceAccountName` å±æ€§æŒ‡å®š ServiceAccount å¯¹è±¡ï¼Œ`pipelineRef` å…³è”æµæ°´çº¿å¯¹è±¡ã€‚åŒæ ·ç›´æ¥åˆ›å»ºè¿™ä¸ªèµ„æºï¼Œåˆ›å»ºåå°±ä¼šè§¦å‘æˆ‘ä»¬çš„æµæ°´çº¿ä»»åŠ¡äº†ï¼š
    
    
    $ kubectl apply -f test-pipelinerun.yaml
    pipelinerun.tekton.dev/test-pipelinerun created
    $ kubectl get pods | grep test-pipelinerun
    test-pipelinerun-build-and-push-pod   0/4     Completed   0              47s
    test-pipelinerun-test-pod             0/2     Completed   0              58s
    $ tkn pipelinerun describe test-pipelinerun
    Name:              test-pipelinerun
    Namespace:         default
    Pipeline Ref:      test-pipeline
    Service Account:   build-sa
    Timeout:           1h0m0s
    Labels:
     tekton.dev/pipeline=test-pipeline
    
    ğŸŒ¡ï¸  Status
    
    STARTED          DURATION   STATUS
    34 seconds ago   23s        Succeeded
    
    ğŸ“¦ Resources
    
     NAME             RESOURCE REF
     âˆ™ git-res        git-res
     âˆ™ harbor-image   harbor-image
    
    ğŸ—‚  Taskruns
    
     NAME                                TASK NAME        STARTED          DURATION   STATUS
     âˆ™ test-pipelinerun-build-and-push   build-and-push   23 seconds ago   12s        Succeeded
     âˆ™ test-pipelinerun-test             test             34 seconds ago   11s        Succeeded
    

åˆ°è¿™é‡Œè¯æ˜æˆ‘ä»¬çš„æµæ°´çº¿æ‰§è¡ŒæˆåŠŸäº†ï¼ŒåŒæ ·åœ¨ Dashboard ä¸Šä¹Ÿå¯ä»¥çœ‹åˆ°ç›¸å…³ä¿¡æ¯ã€‚

![pipelinerun](https://picdn.youdianzhishi.com/images/1658211971947.png)

æˆ‘ä»¬å°† Tekton å®‰è£…åœ¨ Kubernetes é›†ç¾¤ä¸Šï¼Œå®šä¹‰äº†ä¸€ä¸ª Taskï¼Œå¹¶é€šè¿‡ YAML æ¸…å•å’Œ Tekton CLI åˆ›å»º TaskRun å¯¹å…¶è¿›è¡Œäº†æµ‹è¯•ã€‚æˆ‘ä»¬åˆ›å»ºäº†ç”±ä¸¤ä¸ªä»»åŠ¡ç»„æˆçš„ Tekton æµæ°´çº¿ï¼Œç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯ä» GitHub å…‹éš†ä»£ç å¹¶è¿è¡Œåº”ç”¨ç¨‹åºæµ‹è¯•ï¼Œç¬¬äºŒä¸ªä»»åŠ¡æ˜¯æ„å»ºä¸€ä¸ª Docker é•œåƒå¹¶å°†å…¶æ¨é€åˆ° Docker Hub ä¸Šã€‚

## ä½¿ç”¨ Results ä¼ é€’æ•°æ®

ä¸Šé¢æˆ‘ä»¬åœ¨æ„å»ºé•œåƒçš„æ—¶å€™å¯ä»¥çœ‹åˆ°é•œåƒçš„ TAG æˆ‘ä»¬æ˜¯å†™æ­»çš„ï¼Œæˆ–è€…éœ€è¦åœ¨æ¯æ¬¡æ‰§è¡Œçš„æ—¶å€™é€šè¿‡å‚æ•°ä¼ é€’è¿›å»ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è‡ªåŠ¨ç”Ÿæˆé•œåƒ TAG å‘¢ï¼Ÿæ¯”å¦‚æ ¹æ®æ—¶é—´æˆ³æ¥ç”Ÿæˆä¸€ä¸ªæ„å»ºçš„ IDã€‚

è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ª Task ä»»åŠ¡ï¼Œç„¶åé€šè¿‡ `script` è„šæœ¬å»è·å–åˆ°æ•°æ®åä¼ å…¥åˆ° results ä¸­å»ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™äº› results æ•°æ®ä¼ é€’åˆ°æµæ°´çº¿ä¸­çš„å…¶ä»–ä»»åŠ¡ä¸­å»ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³è¦è·å– git commit çš„ SHA å€¼ï¼Œæˆ–è€…ç”Ÿæˆä¸€ä¸ªéšæœºçš„ ID æ¥ä½œä¸ºé•œåƒ TAGï¼Œæ¯”å¦‚è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º `generate-build-id` çš„ Task ä»»åŠ¡ï¼Œå®šä¹‰äº† `get-timestamp` å’Œ `get-buildid` ä¸¤ä¸ª Stepsï¼Œä¸€ä¸ªç”¨äºç”Ÿæˆæ—¶é—´æˆ³ï¼Œä¸€ä¸ªç”¨äºç”Ÿæˆä¸€ä¸ªåŒ…å«åŸºæœ¬ç‰ˆæœ¬çš„ç»“æœå€¼ï¼Œå°†ç»“æœæ·»åŠ åˆ° `results` ä¸­å»ã€‚
    
    
    # generate-build-id.yaml
    apiVersion: tekton.dev/v1beta1
    kind: Task
    metadata:
      name: generate-build-id
    spec:
      description: >-
        Given a base version, this task generates a unique build id by appending
        the base-version to the current timestamp.
      params:
        - name: base-version
          description: Base product version
          type: string
          default: "1.0"
      results:
        - name: timestamp
          description: Current timestamp
        - name: build-id
          description: ID of the current build
      steps:
        - name: get-timestamp
          image: bash:5.0.18
          script: |
            #!/usr/bin/env bash
            ts=`date "+%Y%m%d-%H%M%S"`
            echo "Current Timestamp: ${ts}"
            echo ${ts} | tr -d "\n" | tee $(results.timestamp.path)
        - name: get-buildid
          image: bash:5.0.18
          script: |
            #!/usr/bin/env bash
            ts=`cat $(results.timestamp.path)`
            buildId=$(inputs.params.base-version)-${ts}
            echo ${buildId} | tr -d "\n" | tee $(results.build-id.path)
    

ç›´æ¥åˆ›å»ºä¸Šé¢çš„ Taskï¼š
    
    
    $ kubectl apply -f generate-build-id.yaml
    task.tekton.dev/generate-build-id created
    

åˆ›å»ºå®Œæˆåï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥åœ¨ Pipeline ä¸­æ¥ä½¿ç”¨è¿™ä¸ª Task äº†ï¼Œç”¨æ¥ç”Ÿæˆæ„å»º IDï¼Œä¿®æ”¹ `test-pipeline.yaml`ï¼Œå¢åŠ  `generate-build-id` ä»»åŠ¡ï¼š
    
    
    # test-pipeline.yaml
    apiVersion: tekton.dev/v1beta1
    kind: Pipeline
    metadata:
      name: test-pipeline
    spec:
      resources: # ä¸º Tasks æä¾›è¾“å…¥å’Œè¾“å‡ºèµ„æºå£°æ˜
        - name: git-res
          type: git
        - name: harbor-image
          type: image
      params:
        - name: image-tag
          type: string
      tasks: # æ·»åŠ taskåˆ°æµæ°´çº¿ä¸­
        # è¿è¡Œåº”ç”¨æµ‹è¯•
        - name: test
          taskRef:
            name: test
          resources:
            inputs:
              - name: repo # Task è¾“å…¥åç§°
                resource: git-res # Pipeline èµ„æºåç§°
        - name: get-build-id
          taskRef:
            name: generate-build-id
          params:
            - name: base-version
              value: $(params.image-tag)
        # æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        - name: build-and-push
          taskRef:
            name: build-and-push
          runAfter:
            - test # æµ‹è¯•ä»»åŠ¡æ‰§è¡Œä¹‹å
            - get-build-id
          resources:
            inputs:
              - name: repo # æŒ‡å®šè¾“å…¥çš„gitä»“åº“èµ„æº
                resource: git-res
            outputs: # æŒ‡å®šè¾“å‡ºçš„é•œåƒèµ„æº
              - name: builtImage
                resource: harbor-image
          params:
            - name: imageTag
              value: "$(tasks.get-build-id.results.build-id)"
    

ç„¶ååœ¨ `build-and-push` ä»»åŠ¡ä¸­é€šè¿‡ `"$(tasks.get-build-id.results.build-id)"` è·å–æ„å»ºçš„ IDï¼Œå°†è¿™ä¸ª ID ä½œä¸ºå‚æ•°ä¼ å…¥ä»»åŠ¡ä¸­å»ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦åœ¨ `build-and-push` ä»»åŠ¡ä¸­å¢åŠ  `build-id` è¿™ä¸ªå‚æ•°ï¼š
    
    
    # task-build-push.yaml
    apiVersion: tekton.dev/v1beta1
    kind: Task
    metadata:
      name: build-and-push
    spec:
      resources:
        inputs: # å®šä¹‰è¾“å…¥èµ„æº
          - name: repo #è¾“å…¥èµ„æºï¼Œå°±æ˜¯githubçš„é‚£ä¸ªä»“åº“
            type: git
        outputs: # å®šä¹‰è¾“å‡ºèµ„æº
          - name: builtImage # è¾“å‡ºé•œåƒåå­—
            type: image
      params:
        - name: pathToDockerfile #æŒ‡æ˜ dockerfile åœ¨ä»“åº“ä¸­çš„å“ªä¸ªä½ç½®
          type: string
          default: $(resources.inputs.repo.path)/Dockerfile # repoèµ„æºçš„è·¯å¾„
          description: The path to the dockerfile to build
        - name: pathToContext #æŒ‡æ˜ dockerfile åœ¨ä»“åº“ä¸­çš„å“ªä¸ªä½ç½®
          type: string
          default: $(resources.inputs.repo.path) # repoèµ„æºçš„è·¯å¾„
          description: the build context used by docker daemon
        - name: imageTag
          type: string
          default: "v0.2.0"
          description: the docker image tag
      steps:
        - name: build-and-push
          image: docker:stable
          script: |
            #!/usr/bin/env sh
            docker login harbor.k8s.local
            docker build -t $(resources.outputs.builtImage.url):$(params.imageTag) -f $(params.pathToDockerfile) $(params.pathToContext)
            docker push $(resources.outputs.builtImage.url):$(params.imageTag)  # è¿™è¾¹çš„å‚æ•°éƒ½æ˜¯åœ¨ input å’Œ output ä¸­å®šä¹‰çš„
          env:
            - name: DOCKER_HOST
              value: tcp://docker-dind.kube-ops:2375
    

ç„¶åéœ€è¦å°† `builtImage` è¿™ä¸ª output èµ„æºçš„ url å®šä¹‰ä¸­å°†é•œåƒ tag å»æ‰ï¼Œåœ¨ PipelineRun å¯¹è±¡ä¸­æ–°å¢ image-tag çš„å‚æ•°ï¼š
    
    
    # test-pipelinerun.yaml
    apiVersion: tekton.dev/v1beta1
    kind: PipelineRun
    metadata:
      name: test-pipelinerun
    spec:
      serviceAccountName: build-sa
      pipelineRef:
        name: test-pipeline
      resources:
        - name: git-res # æŒ‡å®šè¾“å…¥çš„gitä»“åº“èµ„æº
          resourceRef:
            name: git-res
        - name: harbor-image # æŒ‡å®šè¾“å‡ºçš„é•œåƒèµ„æº
          resourceRef:
            name: harbor-image
      params:
        - name: image-tag
          value: "v0.3.0"
    

å¦å¤–è¦è®°å¾—å°† `harbor-image` è¿™ä¸ª PipelineResource çš„ url å‚æ•°å€¼å»æ‰é•œåƒ tagï¼š
    
    
    # harbor-image-res.yaml
    apiVersion: tekton.dev/v1alpha1
    kind: PipelineResource
    metadata:
      name: harbor-image
    spec:
      type: image
      params:
        - name: url
          value: harbor.k8s.local/course/tekton-demo
    

æ‰€æœ‰ä¿®æ”¹å®Œæˆåï¼Œé‡æ–°æ‰§è¡Œæˆ‘ä»¬çš„æ•´ä¸ªæµæ°´çº¿å³å¯ã€‚
    
    
    $ tkn pipelinerun logs test-pipelinerun
    [get-build-id : get-timestamp] Current Timestamp: 20220719-064312
    [get-build-id : get-timestamp] 20220719-064312
    
    [get-build-id : get-buildid] v0.3.0-20220719-064312
    
    [test : git-source-repo-s7wcd] {"level":"warn","ts":1658212992.0961232,"caller":"git/git.go:273","msg":"URL(\"https://github.91chi.fun/https://github.com/cnych/tekton-demo.git\") appears to need SSH authentication but no SSH credentials have been provided"}
    [test : git-source-repo-s7wcd] {"level":"info","ts":1658212994.7583172,"caller":"git/git.go:178","msg":"Successfully cloned https://github.91chi.fun/https://github.com/cnych/tekton-demo.git @ 5e1e3a1d0f167b9b639df5b802a0f0f81064d21e (grafted, HEAD, origin/master) in path /workspace/repo"}
    [test : git-source-repo-s7wcd] {"level":"info","ts":1658212994.774911,"caller":"git/git.go:217","msg":"Successfully initialized and updated submodules in path /workspace/repo"}
    
    [test : run-test] PASS
    [test : run-test] ok    _/workspace/repo        0.002s
    
    [build-and-push : create-dir-builtimage-hbn8r] 2022/07/19 06:43:19 warning: unsuccessful cred copy: ".docker" from "/tekton/creds" to "/home/nonroot": unable to create destination directory: mkdir /home/nonroot: permission denied
    
    [build-and-push : git-source-repo-sh7zv] {"level":"warn","ts":1658213001.0883648,"caller":"git/git.go:273","msg":"URL(\"https://github.91chi.fun/https://github.com/cnych/tekton-demo.git\") appears to need SSH authentication but no SSH credentials have been provided"}
    [build-and-push : git-source-repo-sh7zv] {"level":"info","ts":1658213006.4922543,"caller":"git/git.go:178","msg":"Successfully cloned https://github.91chi.fun/https://github.com/cnych/tekton-demo.git @ 5e1e3a1d0f167b9b639df5b802a0f0f81064d21e (grafted, HEAD, origin/master) in path /workspace/repo"}
    [build-and-push : git-source-repo-sh7zv] {"level":"info","ts":1658213006.5069387,"caller":"git/git.go:217","msg":"Successfully initialized and updated submodules in path /workspace/repo"}
    
    [build-and-push : build-and-push] Authenticating with existing credentials...
    [build-and-push : build-and-push] WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
    [build-and-push : build-and-push] Configure a credential helper to remove this warning. See
    [build-and-push : build-and-push] https://docs.docker.com/engine/reference/commandline/login/#credentials-store
    [build-and-push : build-and-push]
    [build-and-push : build-and-push] Login Succeeded
    [build-and-push : build-and-push] Sending build context to Docker daemon  157.7kB
    [build-and-push : build-and-push] Step 1/6 : FROM golang:1.14-alpine
    [build-and-push : build-and-push]  ---> 32dc91e030ac
    # ......
    [build-and-push : build-and-push] c1f81aac25d2: Pushed
    [build-and-push : build-and-push] v0.3.0-20220719-064312: digest: sha256:36e2333b77e890f4120f844b39e11df64140821a0814c15c0e4ee18c80caa8bf size: 2198
    
    [build-and-push : image-digest-exporter-8npsc] {"severity":"INFO","timestamp":"2022-07-19T06:43:31.247211063Z","caller":"logging/config.go:116","message":"Successfully created the logger."}
    [build-and-push : image-digest-exporter-8npsc] {"severity":"INFO","timestamp":"2022-07-19T06:43:31.247263791Z","caller":"logging/config.go:117","message":"Logging level set to: info"}
    [build-and-push : image-digest-exporter-8npsc] {"severity":"INFO","timestamp":"2022-07-19T06:43:31.247373395Z","caller":"imagedigestexporter/main.go:59","message":"No index.json found for: builtImage","commit":"19940f2"}
    

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ `get-build-id` ä»»åŠ¡ä¸­ä¸ºæˆ‘ä»¬ç”Ÿæˆäº† `v0.3.0-20210617-125634` è¿™æ ·çš„é•œåƒ TAGï¼Œæœ€åä¹Ÿé€šè¿‡ results ä¼ é€’åˆ°äº†ä¸‹é¢çš„æ„å»ºä»»åŠ¡ä¸­å»ï¼Œé•œåƒçš„ TAG ä¹Ÿæ›´æ–°äº†ã€‚

![tekton build id](https://picdn.youdianzhishi.com/images/1658213177833.png)

## Tekton Catalog

å½“ç„¶è¿™äº›ä»»åŠ¡å…¶å®éƒ½å…·æœ‰ä¸€å®šçš„é€šç”¨æ€§çš„ï¼Œä¸ºæ­¤ Tekton å®˜æ–¹æä¾›äº†ä¸€ä¸ª Catalog çš„æœåŠ¡ï¼Œç”¨æ¥ä¸“é—¨æä¾›ä¸€äº›é€šç”¨çš„ä»»åŠ¡ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³è¦è·å– Git Commit çš„ç›¸å…³ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ <https://artifacthub.io/packages/tekton-task/tekton-catalog-tasks/git-clone> è¿™ä¸ª Catalogï¼Œæ–‡æ¡£ä¸­ä¹ŸåŒ…å«ç›¸å…³çš„ä½¿ç”¨è¯´æ˜ã€‚Tekton å®˜æ–¹ä¹Ÿæä¾›äº†ä¸€ä¸ª [Tekton Hub](https://hub.tekton.dev/) ç½‘ç«™æ¥åˆ†äº«ä¸€äº› Catalog æœåŠ¡ã€‚

![Tekton Hub](https://picdn.youdianzhishi.com/images/1658213385976.png)

åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº†ä½¿ç”¨ Tekton åˆ›å»º CI/CD æµæ°´çº¿çš„ä¸€ä¸ªç®€å•ç¤ºä¾‹ï¼Œä¸è¿‡è¿™ä¸ªç¤ºä¾‹è¿˜æ¯”è¾ƒç®€å•ã€‚

## Sidecar

åœ¨ Tekton ä¸­è¿˜æœ‰ä¸€é¡¹åŠŸèƒ½å°±æ˜¯ Sidecarï¼Œå’Œ Pod ä¸­çš„ Sidecar ç±»ä¼¼ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œç”¨äºå’Œ Task ä»»åŠ¡çš„ Steps ä¸­æŒ‡å®šçš„å®¹å™¨ä¸€èµ·è¿è¡Œï¼Œä¸ºè¿™äº› Steps çš„æ‰§è¡Œæä¾›ä¸€äº›è¾…åŠ©æ”¯æŒï¼Œæ¯”å¦‚ Sidecar å¯ä»¥è¿è¡Œä¸€ä¸ª logging daemonã€æ›´æ–°å…±äº« volume ä¸Šçš„æ–‡ä»¶æˆ–è€…æä¾›ç½‘ç»œä»£ç†ç­‰åŠŸèƒ½ã€‚

Tekton ä¼šå°† Sidecar æ³¨å…¥å±äº TaskRun çš„ Podï¼Œä¸€æ—¦ Task ä¸­çš„æ‰€æœ‰ Steps å®Œæˆæ‰§è¡Œï¼ŒPod å†…è¿è¡Œçš„æ¯ä¸€ä¸ª Sidecar å°±ä¼šç»ˆæ­¢æ‰ï¼Œå¦‚æœ Sidecar æˆåŠŸé€€å‡ºï¼Œ`kubectl get pods` å‘½ä»¤ä¼šå°† Pod çš„çŠ¶æ€è¿”å›ä¸º `Completed`ï¼Œå¦‚æœ Sidecar é€€å‡ºæ—¶å‡ºç°äº†é”™è¯¯ï¼Œåˆ™è¿”å› `Error`ï¼Œè€Œå¿½ç•¥å®é™…æ‰§è¡Œ Pod å†…éƒ¨ Steps çš„å®¹å™¨é•œåƒçš„é€€å‡ºç å€¼ã€‚

ä»¥å‰æˆ‘ä»¬åœ¨æ„å»ºå®¹å™¨é•œåƒçš„æ—¶å€™æ˜¯é€šè¿‡æŒ‚è½½å®¿ä¸»æœºçš„ `docker.sock` æ–‡ä»¶åˆ°å®¹å™¨ä¸­æ¥æ‰§è¡Œçš„ï¼ˆä¸Šé¢æˆ‘ä»¬æ˜¯é€šè¿‡ `DOCKER_HOST` ç¯å¢ƒå˜é‡æ¥æŒ‡å®š Daemon åœ°å€ï¼‰ï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´è¿™ç§æ–¹å¼å« `Dood - Docker Outside of Docker`ï¼Œ`DooD` é€šè¿‡ç»‘å®šå®‰è£… Docker å¥—æ¥å­—æ¥ä½¿ç”¨å…¶åº•å±‚å®¿ä¸»æœºçš„ Docker Daemonï¼Œè€ŒçœŸæ­£çš„ `DinD` æ˜¯åœ¨å…¶ä¸­åŒ…å«ä¸€ä¸ªå®Œæ•´çš„ Docker æœåŠ¡ã€‚æ˜¾ç„¶ `DooD` è¿™ç§æ–¹å¼æ›´å¿«ï¼Œå› ä¸ºå¯ä»¥åˆ©ç”¨å®ƒçš„ç¼“å­˜æœºåˆ¶ï¼Œè€Œ `DinD` æ˜¾ç„¶æ›´åŠ å®‰å…¨ã€æ›´åŠ å¹²å‡€ï¼Œå¯¹å®¿ä¸»æœºäº§ç”Ÿçš„å½±å“æ›´å°ï¼Œè€Œä¸”æ”¯æŒå¹¶è¡Œè¿è¡Œï¼Œå› ä¸ºæ¯ä¸ªå®¹å™¨é‡Œé¢éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ Docker Daemonï¼Œäº’ç›¸ä¸å—å½±å“ï¼Œå½“ç„¶ `DooD` æ›´åŠ ç®€å•æ˜“ç”¨ã€‚è¿™é‡Œæˆ‘ä»¬å°±æ¥ä½¿ç”¨ Sidecar çš„æ–¹å¼ä¸º Tekton ä¸­çš„å®¹å™¨æ„å»ºæä¾›ä¸€ä¸ª `DinD` æ¨¡å¼çš„æ„å»ºæœåŠ¡ã€‚

æ–°å»ºä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„ Task ä»»åŠ¡ï¼Œä¸“é—¨ç”¨æ¥æ„å»º Docker é•œåƒï¼š
    
    
    # task-docker-build.yaml
    apiVersion: tekton.dev/v1beta1
    kind: Task
    metadata:
      name: docker-build-push
    spec:
      resources:
        inputs: # å®šä¹‰è¾“å…¥èµ„æº
          - name: source # æºä»£ç ä»“åº“
            type: git
      params:
        - name: image
          description: Reference of the image docker will produce.
        - name: builder_image
          description: The location of the docker builder image.
          default: docker:stable
        - name: dockerfile
          description: Path to the Dockerfile to build.
          default: ./Dockerfile
        - name: context
          description: Path to the directory to use as context.
          default: .
        - name: build_extra_args
          description: Extra parameters passed for the build command when building images.
          default: ""
        - name: push_extra_args
          description: Extra parameters passed for the push command when pushing images.
          default: ""
        - name: insecure_registry
          description: Allows the user to push to an insecure registry that has been specified
          default: ""
        - name: registry_mirror
          description: Specific the docker registry mirror
          default: ""
        - name: registry_url
          description: private docker images registry url
      steps:
        - name: docker-build # æ„å»ºæ­¥éª¤
          image: $(params.builder_image)
          env:
            - name: DOCKER_HOST # ç”¨ TLS å½¢å¼é€šè¿‡ TCP é“¾æ¥ sidecar
              value: tcp://localhost:2376
            - name: DOCKER_TLS_VERIFY # æ ¡éªŒ TLS
              value: "1"
            - name: DOCKER_CERT_PATH # ä½¿ç”¨ sidecar å®ˆæŠ¤è¿›ç¨‹ç”Ÿæˆçš„è¯ä¹¦
              value: /certs/client
          workingDir: $(resources.inputs.source.path)
          script: | # docker æ„å»ºå‘½ä»¤
            docker login $(params.registry_url)
            docker build \
              $(params.build_extra_args) \
              --no-cache \
              -f $(params.dockerfile) -t $(params.image) $(params.context)
          volumeMounts: # å£°æ˜æŒ‚è½½è¯ä¹¦ç›®å½•
            - mountPath: /certs/client
              name: dind-certs
        - name: docker-push #
          image: $(params.builder_image)
          env:
            - name: DOCKER_HOST
              value: tcp://localhost:2376
            - name: DOCKER_TLS_VERIFY
              value: "1"
            - name: DOCKER_CERT_PATH
              value: /certs/client
          workingDir: $(resources.inputs.source.path)
          script: | # æ¨é€ docker é•œåƒ
            docker push $(params.push_extra_args) $(params.image)
          volumeMounts:
            - mountPath: /certs/client
              name: dind-certs
      sidecars: # sidecar æ¨¡å¼ï¼Œæä¾› docker daemonæœåŠ¡ï¼Œå®ç°çœŸæ­£çš„ DinD æ¨¡å¼
        - image: docker:dind
          name: server
          args:
            - --storage-driver=vfs
            - --userland-proxy=false
            - --debug
            - --insecure-registry=$(params.insecure_registry)
            - --registry-mirror=$(params.registry_mirror)
          securityContext:
            privileged: true
          env:
            - name: DOCKER_TLS_CERTDIR # å°†ç”Ÿæˆçš„è¯ä¹¦å†™å…¥ä¸å®¢æˆ·ç«¯å…±äº«çš„è·¯å¾„
              value: /certs
          volumeMounts:
            - mountPath: /certs/client
              name: dind-certs
          readinessProbe: # ç­‰å¾… dind daemon ç”Ÿæˆå®ƒä¸å®¢æˆ·ç«¯å…±äº«çš„è¯ä¹¦
            periodSeconds: 1
            exec:
              command: ["ls", "/certs/client/ca.pem"]
      volumes: # ä½¿ç”¨ emptyDir çš„å½¢å¼å³å¯
        - name: dind-certs
          emptyDir: {}
    

ä¸Šé¢çš„ Task æœ€é‡è¦çš„å°±æ˜¯å…¶ä¸­çš„ `sidecars` éƒ¨åˆ†ï¼Œä½¿ç”¨äº†ä¸€ä¸ª `docker:dind` é•œåƒæ¥æä¾› docker æœåŠ¡ç«¯ï¼Œç”±äºæ˜¯ sidecar æ¨¡å¼ï¼Œæ‰€ä»¥å®ƒå’Œä¸Šé¢æ„å»ºçš„ steps ä¸­çš„å®¹å™¨æ˜¯å…±äº« network namespace çš„ï¼Œæ‰€ä»¥åœ¨æ„å»ºçš„æ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡ `tcp://localhost:2376` å’Œ docker æœåŠ¡ç«¯è¿›è¡Œé€šä¿¡ï¼Œç”±äºè¿˜ä½¿ç”¨çš„æ˜¯ TLS è¯ä¹¦æ¨¡å¼ï¼Œæ‰€ä»¥éœ€è¦å°†è¯ä¹¦ç›®å½•è¿›è¡Œå£°æ˜æŒ‚è½½ã€‚

æ¥ç€é‡æ–°ä¿®æ”¹æˆ‘ä»¬çš„ Pipeline æµæ°´çº¿ï¼š
    
    
    # test-pipeline.yaml
    apiVersion: tekton.dev/v1beta1
    kind: Pipeline
    metadata:
      name: test-sidecar-pipeline
    spec:
      resources: # ä¸º Tasks æä¾›è¾“å…¥å’Œè¾“å‡ºèµ„æºå£°æ˜
        - name: git-res
          type: git
      params:
        - name: image
          type: string
        - name: image-tag
          type: string
          default: "v0.4.0"
        - name: registry_url
          type: string
          default: "harbor.k8s.local"
        - name: registry_mirror
          type: string
          default: "https://ot2k4d59.mirror.aliyuncs.com/"
        - name: insecure_registry
          type: string
          default: "harbor.k8s.local"
      tasks: # æ·»åŠ taskåˆ°æµæ°´çº¿ä¸­
        # è¿è¡Œåº”ç”¨æµ‹è¯•
        - name: test
          taskRef:
            name: test
          resources:
            inputs:
              - name: repo # Task è¾“å…¥åç§°
                resource: git-res # Pipeline èµ„æºåç§°
        - name: get-build-id
          taskRef:
            name: generate-build-id
          params:
            - name: base-version
              value: $(params.image-tag)
        # æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        - name: build-and-push
          taskRef:
            name: docker-build-push # ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„é•œåƒæ„å»ºä»»åŠ¡
          runAfter:
            - test # æµ‹è¯•ä»»åŠ¡æ‰§è¡Œä¹‹å
          resources:
            inputs:
              - name: source # æŒ‡å®šè¾“å…¥çš„gitä»“åº“èµ„æº
                resource: git-res
          params:
            - name: image
              value: "$(params.image):$(tasks.get-build-id.results.build-id)"
            - name: registry_url
              value: $(params.registry_url)
            - name: insecure_registry
              value: $(params.insecure_registry)
            - name: registry_mirror
              value: $(params.registry_mirror)
    

è¿™é‡Œçš„æµæ°´çº¿æœ€é‡è¦çš„å°±æ˜¯å°†é•œåƒæ„å»ºçš„ä»»åŠ¡æ›¿æ¢æˆä¸Šé¢çš„ `docker-build-push` è¿™ä¸ª Taskï¼Œç„¶åä¼ å…¥å‡ ä¸ªéœ€è¦çš„å‚æ•°ï¼Œæ¥ç€ä¿®æ”¹ PipelineRunï¼š
    
    
    apiVersion: tekton.dev/v1beta1
    kind: PipelineRun
    metadata:
      name: test-sidecar-pipelinerun
    spec:
      serviceAccountName: build-sa
      pipelineRef:
        name: test-sidecar-pipeline
      resources:
        - name: git-res # æŒ‡å®šè¾“å…¥çš„gitä»“åº“èµ„æº
          resourceRef:
            name: git-res
      params:
        - name: image
          value: harbor.k8s.local/course/tekton-demo
    

è¿™é‡Œå°±æ¯”è¾ƒç®€å•äº†ï¼Œåªéœ€è¦å¼•ç”¨ä¸Šé¢çš„ Pipeline æµæ°´çº¿ï¼Œç„¶åæä¾›éœ€è¦çš„å‡ ä¸ªå‚æ•°å³å¯ï¼Œç›´æ¥åˆ›å»ºä¸Šé¢çš„å‡ ä¸ªèµ„æºå¯¹è±¡å³å¯æ‰§è¡Œæˆ‘ä»¬çš„æµæ°´çº¿äº†ï¼š
    
    
    $ tkn pr list
    NAME                       STARTED         DURATION     STATUS
    test-sidecar-pipelinerun   3 minutes ago   2 minutes    Succeeded
    test-pipelinerun           1 day ago       1 minute     Succeeded
    $ tkn pr describe test-sidecar-pipelinerun
    Name:              test-sidecar-pipelinerun
    Namespace:         default
    Pipeline Ref:      test-sidecar-pipeline
    Service Account:   build-sa
    Timeout:           1h0m0s
    Labels:
     tekton.dev/pipeline=test-sidecar-pipeline
    
    ğŸŒ¡ï¸  Status
    
    STARTED         DURATION    STATUS
    5 minutes ago   2 minutes   Succeeded
    
    ğŸ“¦ Resources
    
     NAME         RESOURCE REF
     âˆ™ git-res   git-res
    
    âš“ Params
    
     NAME      VALUE
     âˆ™ image   harbor.k8s.local/course/tekton-demo
    
    ğŸ“ Results
    
     No results
    
    ğŸ“‚ Workspaces
    
     No workspaces
    
    ğŸ—‚  Taskruns
    
     NAME                                              TASK NAME        STARTED         DURATION     STATUS
     âˆ™ test-sidecar-pipelinerun-build-and-push-bmrpn   build-and-push   4 minutes ago   1 minute     Succeeded
     âˆ™ test-sidecar-pipelinerun-test-l4k2x             test             5 minutes ago   9 seconds    Succeeded
     âˆ™ test-sidecar-pipelinerun-get-build-id-r72xl     get-build-id     5 minutes ago   28 seconds   Succeeded
    

æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°å¾ˆå¿«å°±æ„å»ºæˆåŠŸäº†ï¼š

![dind æ¨¡å¼](https://picdn.youdianzhishi.com/images/20210619170428.png)

æœ€ç»ˆåœ¨ Harbor ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆšåˆšæ¨é€çš„é•œåƒç‰ˆæœ¬ï¼š

![dind å‚æ•°çš„é•œåƒ](https://picdn.youdianzhishi.com/images/20210619170731.png)

è¿™ç§æ–¹å¼è¿˜å¯ä»¥é¿å…åœ¨å®¿ä¸»æœºä¸Šäº§ç”Ÿå¤§é‡æ— ç”¨çš„æ„å»ºè¿‡ç¨‹äº§ç”Ÿçš„é•œåƒï¼Œå› ä¸ºæ¯æ¬¡æ„å»ºå®Œæˆå°±é”€æ¯æ‰äº†ï¼Œè¿™æ‰æ˜¯çœŸæ­£çš„ `Docker IN Docker`ï¼Œä¹Ÿæ˜¯ Tekton ä¸­çš„ Sidecar çš„ä¸€ä¸ªä½¿ç”¨åœºæ™¯ã€‚

## Workspaces

åœ¨å®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦çš„ä¸€ä¸ªåŠŸèƒ½æ˜¯èƒ½å¤Ÿåœ¨ä»»åŠ¡ä¹‹é—´å…±äº«åˆ¶å“ï¼Œä»¥ä¾¿ç¼“å­˜æ„å»ºå·¥å…·ï¼ˆæ¯”å¦‚ Maven å’Œ NPMï¼‰çš„ä¾èµ–é¡¹ï¼Œåœ¨ Tekton 0.10 ç‰ˆæœ¬å°±å‘å¸ƒå¢åŠ äº†å¯¹ Workspaces çš„æ”¯æŒï¼Œè¿™ä½¿å¾—æµæ°´çº¿ä¸­çš„ä»»åŠ¡å¯ä»¥æ›´åŠ è½»æ¾åœ°ä½¿ç”¨ PV æ¥å…±äº«æ•°æ®äº†ï¼ŒWorkspaces å…è®¸æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ª pipeline ä¸­ task è¿è¡Œæ—¶éœ€è¦çš„ volumeã€‚

Tekton Pipelines ä¸­çš„ Workspaces æ˜¯æŒ‡æµæ°´çº¿è¿è¡Œæ—¶éœ€è¦çš„å…±äº«å·çš„å£°æ˜ï¼Œåœ¨æµæ°´çº¿å®šä¹‰ä¸­ï¼ŒWorkspaces å¯ä»¥ä½œä¸ºå…±äº«å·ä¼ é€’ç»™ç›¸å…³ä»»åŠ¡ï¼Œè¿™æ ·å½“ä¸ºå¤šä¸ªä»»åŠ¡æä¾›ç›¸åŒçš„ Workspaces çš„æ—¶å€™ï¼Œå®ƒä»¬å°±å¯ä»¥ä»ç›¸åŒçš„ Volumes ä¸­è¯»å–å’Œå†™å…¥æ•°æ®ã€‚å½“ç„¶ Workspaces çš„ Volumes å·é™¤äº†å¯ä»¥æ˜¯ PVCï¼Œä¹Ÿå¯ä»¥æ˜¯ ConfigMapï¼Œæˆ–è€…æ˜¯åœ¨ä»»åŠ¡ä¹‹é—´æŒ‚è½½å’Œå…±äº«çš„ Secret èµ„æºã€‚

æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹åœ¨å®è·µä¸­å¦‚ä½•ä½¿ç”¨ Workspaces æ¥ç¼“å­˜ Maven ä¾èµ–ï¼ŒåŠ é€Ÿæµæ°´çº¿çš„æ„å»ºï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„é¡¹ç›®ä¸ºï¼š<https://github.com/cnych/spring-petclinic>ã€‚

è¦åœ¨æµæ°´çº¿ä¸­æ„å»º Maven é¡¹ç›®ï¼Œå½“ç„¶éœ€è¦å®šä¹‰ä¸€ä¸ª Maven çš„ Task ä»»åŠ¡ï¼Œå…¶å®åœ¨ Tekton Catalog é‡Œé¢å°±å·²ç»åŒ…å«äº†è¿™æ ·çš„é€šç”¨çš„ Task äº†ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œä¸€äº›ä¿®æ”¹æ¥ä¸º Maven çš„ä¾èµ–é¡¹æ·»åŠ  Workspaces æ”¯æŒã€‚
    
    
    # workspace-mvn-task.yaml
    apiVersion: tekton.dev/v1beta1
    kind: Task
    metadata:
      name: mvn-task
    spec:
      workspaces:
        - name: maven-repo
      resources:
        inputs:
          - name: source
            type: git
      params:
        - name: GOALS
          description: The Maven goals to run
          type: array
          default: ["package"]
      steps:
        - name: mvn
          image: cnych/cloud-builders-mvn:tekton
          workingDir: /workspace/source
          command: ["/usr/bin/mvn"]
          args:
            - -Dmaven.repo.local=$(workspaces.maven-repo.path)
            - "$(inputs.params.GOALS)"
    

ä¸Šé¢çš„ä»»åŠ¡ä¸­æˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªåä¸º `maven-repo` çš„ Workspaceï¼Œè¯¥å·¥ä½œåŒºè§„å®šæ— è®ºä½•æ—¶è¿è¡Œè¯¥ä»»åŠ¡ï¼Œéƒ½åº”è¯¥æä¾›å¹¶é…ç½®ä¸€ä¸ªå·æ¥å……å½“æœ¬åœ°çš„ Maven å­˜å‚¨åº“ï¼Œç„¶åå°†å·¥ä½œåŒºçš„è·¯å¾„ä¼ é€’ç»™ Maven å‘½ä»¤ï¼Œä»¥ä¾¿é€šè¿‡ `-Dmaven.repo.local=$(workspaces.maven-repo.path)` å‘½ä»¤å°†å·¥ä½œåŒºçš„è·¯å¾„ä½œä¸ºæœ¬åœ°çš„ Maven åº“ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é…ç½® Workspace æŒ‚è½½çš„è·¯å¾„ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„è·¯å¾„ã€‚

æ¥ç€æˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸ªä½¿ç”¨ Maven ä»»åŠ¡æ„å»º Java åº”ç”¨ç¨‹åºçš„æµæ°´çº¿ Pipelineï¼Œä¸ºäº†æ¼”ç¤º Maven ä¾èµ–çš„ç¼“å­˜æ•ˆæœï¼Œè¿™é‡Œçš„æµæ°´çº¿æˆ‘ä»¬è¿è¡Œ 3 ä¸ª Maven ä»»åŠ¡æ¥æ‰§è¡Œæ„å»ºã€é›†æˆæµ‹è¯•ï¼Œå¹¶ç”Ÿæˆæµ‹è¯•ç»“æœå’Œä»£ç è¦†ç›–ç‡ç­‰æŠ¥å‘Šã€‚

![maven pipeline](https://picdn.youdianzhishi.com/images/20210618150611.png)

æµæ°´çº¿å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š
    
    
    # workspace-mvn-pipeline.yaml
    apiVersion: tekton.dev/v1beta1
    kind: Pipeline
    metadata:
      name: mvn-pipeline
    spec:
      workspaces: # å£°æ˜ workspaces
        - name: local-maven-repo
      resources: # å£°æ˜ä½¿ç”¨çš„èµ„æº
        - name: app-git
          type: git
      tasks:
        - name: build # æ„å»ºä»»åŠ¡
          taskRef:
            name: mvn-task # å¼•ç”¨ä¸Šé¢çš„ mvn ä»»åŠ¡
          resources: # ä¼ é€’ resources èµ„æº
            inputs:
              - name: source
                resource: app-git
          params: # ä¼ é€’ params å‚æ•°
            - name: GOALS
              value: ["package"]
          workspaces: # ä¼ é€’ workspaces
            - name: maven-repo
              workspace: local-maven-repo
        - name: int-test # æµ‹è¯•ä»»åŠ¡
          taskRef:
            name: mvn-task
          runAfter: ["build"] # éœ€è¦ build ä»»åŠ¡æ‰§è¡Œå®Œæˆå
          resources:
            inputs:
              - name: source
                resource: app-git
          params:
            - name: GOALS
              value: ["verify"]
          workspaces:
            - name: maven-repo
              workspace: local-maven-repo
        - name: gen-report # æµ‹è¯•æŠ¥å‘Š
          taskRef:
            name: mvn-task
          runAfter: ["build"] # éœ€è¦ build ä»»åŠ¡æ‰§è¡Œå®Œæˆå
          resources:
            inputs:
              - name: source
                resource: app-git
          params:
            - name: GOALS
              value: ["site"]
          workspaces:
            - name: maven-repo
              workspace: local-maven-repo
    

éœ€è¦æ³¨æ„æµæ°´çº¿ä¸­çš„ `local-maven-repo` å·¥ä½œåŒºçš„å£°æ˜ï¼Œå®ƒæŒ‡å‡ºï¼Œå½“æ­¤æµæ°´çº¿è¿è¡Œæ—¶ï¼Œåº”æä¾›ä¸€ä¸ªå·å¹¶å°†å…¶ç”¨ä½œæ­¤å·¥ä½œåŒºï¼Œç„¶åå°†æ­¤å·¥ä½œåŒºæä¾›ç»™æ­¤æµæ°´çº¿ä¸­çš„æ¯ä¸ªä»»åŠ¡ï¼Œä»¥ä¾¿å®ƒä»¬éƒ½å…±äº«ç›¸åŒçš„å·¥ä½œåŒºã€‚ç„¶åæˆ‘ä»¬æ ¹æ®ä¼ å…¥çš„ `GOALS` å‚æ•°æ¥å†³å®šåº”è¯¥æ‰§è¡Œçš„ä»»åŠ¡ã€‚

æµæ°´çº¿ Pipeline å£°æ˜å®Œæˆåï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥è¿è¡Œè¿™ä¸ªæµæ°´çº¿æ¥æ„å»º `Spring PetClinic` è¿™ä¸ªç¤ºä¾‹åº”ç”¨äº†ï¼Œåœ¨å¯åŠ¨æµæ°´çº¿ä¹‹å‰ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª PVC æ¥æä¾›ä¸€ä¸ª Workspace å¯¹ Maven ä¾èµ–é¡¹è¿›è¡Œç¼“å­˜ã€‚
    
    
    # workspace-mvn-pvc.yaml
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: mvn-repo-pvc
    spec:
      resources:
        requests:
          storage: 5Gi
      volumeMode: Filesystem
      storageClassName: nfs-client # ä½¿ç”¨ StorageClass è‡ªåŠ¨ç”Ÿæˆ PV
      accessModes:
        - ReadWriteOnce
    

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªåä¸º `nfs-client` çš„ StorageClassï¼Œè¿™æ ·å°±å¯ä»¥è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„ PV è¿›è¡Œç»‘å®šï¼Œå¦‚æœä½ æ²¡æœ‰éœ€è¦è‡ªè¡Œåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„é™æ€ PVã€‚

ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªä½¿ç”¨ä¸Šè¿° PVC ä½œä¸ºæµæ°´çº¿å·¥ä½œåŒºçš„ PipelineRun æ¥æ‰§è¡Œæµæ°´çº¿äº†ï¼š
    
    
    # workspace-mvn-pipelinerun.yaml
    apiVersion: tekton.dev/v1beta1
    kind: PipelineRun
    metadata:
      name: mvn-pipelinerun
    spec:
      pipelineRef:
        name: mvn-pipeline
      resources:
        - name: app-git
          resourceSpec:
            type: git
            params:
              - name: url
                value: https://github.91chi.fun/https://github.com/cnych/spring-petclinic
      workspaces:
        - name: local-maven-repo
          persistentVolumeClaim:
            claimName: mvn-repo-pvc
    

è¯·æ³¨æ„ PVC å’Œä¸ºç¼“å­˜ maven ä¾èµ–é¡¹è€Œå£°æ˜çš„å·¥ä½œåŒºä¹‹é—´çš„æ˜ å°„ï¼Œ`mvn-repo-pvc` è¢«ä¼ é€’åˆ°æµæ°´çº¿å’Œç›¸åº”çš„ä»»åŠ¡ä½œä¸ºç¼“å­˜æ–‡ä»¶å’Œåˆ¶å“çš„å…±äº«å·ã€‚

ç¬¬ä¸€æ¬¡æµæ°´çº¿è¿è¡Œå°†éœ€è¦ä¸€äº›æ—¶é—´æ¥ä¸‹è½½ä¾èµ–é¡¹æ‰§è¡Œä»»åŠ¡ï¼Œç›´æ¥åˆ›å»ºä¸Šé¢å£°æ˜çš„å‡ ä¸ªèµ„æºå¯¹è±¡ï¼Œè§‚å¯Ÿ PipelineRun çš„æ‰§è¡Œè¿‡ç¨‹ï¼š
    
    
    kubectl apply -f workspace-mvn-task.yaml
    kubectl apply -f workspace-mvn-pipeline.yaml
    kubectl apply -f workspace-mvn-pvc.yaml
    kubectl apply -f workspace-mvn-pipelinerun.yaml
    

å½“ç¬¬ä¸€æ¬¡æ‰§è¡Œæµæ°´çº¿çš„æ—¶å€™ä¼šåœ¨æ‰§è¡Œ `mvn` å‘½ä»¤çš„æ—¶å€™æ¶ˆè€—å¤§é‡çš„æ—¶é—´ï¼Œå› ä¸ºéœ€è¦ä¸‹è½½ä¾èµ–åŒ…ï¼Œæˆ‘è¿™é‡Œçš„ç¯å¢ƒå·®ä¸å¤šç­‰äº† 20 åˆ†é’Ÿå·¦å³ï¼š

![mvn packages](https://picdn.youdianzhishi.com/images/20210618153727.png)

ç„¶ååœ¨æ‰§è¡Œåé¢çš„ä¸¤ä¸ªä»»åŠ¡çš„æ—¶å€™å°±éå¸¸å¿«äº†ï¼Œå› ä¸ºå‰é¢ä»»åŠ¡æ‰§è¡Œå®Œæˆåä¼šæŠŠä¾èµ–é¡¹å­˜å…¥åˆ° Workspace å£°æ˜çš„ PVC ä¸­å»ï¼Œåé¢çš„ä»»åŠ¡ç›´æ¥ä½¿ç”¨äº†è¿™ä¸ª Workspaceï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°æ‰§è¡Œä¸€æ¬¡ PipelineRunï¼Œå¯¹æ¯”ä¸‹å‰åä¸¤æ¬¡çš„æ—¶é—´ï¼Œåœ¨æˆ‘çš„ç¯å¢ƒä¸­ï¼Œæ‰§è¡Œæ—¶é—´ç”± 37 åˆ†é’Ÿå‡å°‘åˆ°å¤§çº¦ä¸¤åˆ†é’Ÿã€‚
    
    
    $ tkn pr list
    NAME                      STARTED         DURATION     STATUS
    mvn-pipelinerun-r-fgwf2   3 minutes ago   2 minutes    Succeeded
    mvn-pipelinerun           2 hours ago     37 minutes   Succeeded
    # æŸ¥çœ‹ç¬¬ä¸€æ¬¡pipelinerunçš„æ‰§è¡Œæƒ…å†µ
    $ tkn pr describe mvn-pipelinerun
    Name:              mvn-pipelinerun
    Namespace:         default
    Pipeline Ref:      mvn-pipeline
    Service Account:   default
    Timeout:           1h0m0s
    Labels:
     tekton.dev/pipeline=mvn-pipeline
    
    ğŸŒ¡ï¸  Status
    
    STARTED       DURATION     STATUS
    2 hours ago   37 minutes   Succeeded
    ......
    ğŸ—‚  Taskruns
    
     NAME                                 TASK NAME    STARTED       DURATION     STATUS
     âˆ™ mvn-pipelinerun-int-test-mbppx     int-test     2 hours ago   33 seconds   Succeeded
     âˆ™ mvn-pipelinerun-gen-report-xlns9   gen-report   2 hours ago   36 minutes   Succeeded
     âˆ™ mvn-pipelinerun-build-x9zkf        build        2 hours ago   20 minutes   Succeeded
    
    # æŸ¥çœ‹ç¬¬äºŒæ¬¡æ‰§è¡Œçš„è¯¦ç»†ä¿¡æ¯
    $ tkn pr describe mvn-pipelinerun-r-fgwf2
    Name:              mvn-pipelinerun-r-fgwf2
    Namespace:         default
    Pipeline Ref:      mvn-pipeline
    Service Account:   default
    Timeout:           1h0m0s
    Labels:
     reruns=mvn-pipelinerun
     tekton.dev/pipeline=mvn-pipeline
    
    ğŸŒ¡ï¸  Status
    
    STARTED         DURATION    STATUS
    4 minutes ago   2 minutes   Succeeded
    ......
    
    ğŸ—‚  Taskruns
    
     NAME                                         TASK NAME    STARTED         DURATION     STATUS
     âˆ™ mvn-pipelinerun-r-fgwf2-gen-report-n69g8   gen-report   4 minutes ago   1 minute     Succeeded
     âˆ™ mvn-pipelinerun-r-fgwf2-int-test-4g58z     int-test     4 minutes ago   32 seconds   Succeeded
     âˆ™ mvn-pipelinerun-r-fgwf2-build-ftqgr        build        4 minutes ago   38 seconds   Succeeded
    

æµ‹è¯•ä»»åŠ¡è¿è¡Œæ²¡æœ‰å—åˆ°å¤ªå¤§å½±å“ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†å¤§éƒ¨åˆ†åœ¨æ„å»ºä»»åŠ¡è¿è¡Œä¸­ä¸‹è½½çš„ä¾èµ–é¡¹ï¼Œå³ä½¿åœ¨ç¬¬ä¸€æ¬¡æµæ°´çº¿è¿è¡Œä¸­ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

![maven pipelinerun](https://picdn.youdianzhishi.com/images/20210618215202.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åˆ©ç”¨ Workspaces åŠŸèƒ½å¯ä»¥å¯¹æˆ‘ä»¬çš„æµæ°´çº¿æ„å»ºè¿›è¡Œå¤§å¹…åº¦çš„ä¼˜åŒ–ï¼Œç‰¹åˆ«æ˜¯å¯¹äºä¾èµ–åŒ…ç‰¹åˆ«å¤§çš„åº”ç”¨ï¼Œæ¯”å¦‚ Mavenã€NPMã€Go Modules ç­‰ã€‚

## Run

`Run` å…è®¸ä½ å®ä¾‹åŒ–å’Œæ‰§è¡Œè‡ªå®šä¹‰ä»»åŠ¡ï¼Œå¯ä»¥é€šè¿‡åœ¨é›†ç¾¤ä¸Šè¿è¡Œçš„è‡ªå®šä¹‰ä»»åŠ¡æ§åˆ¶å™¨æ¥å®ç°ã€‚è‡ªå®šä¹‰ä»»åŠ¡å¯ä»¥å®ç°ä¸åœ¨é›†ç¾¤ä¸Šçš„ Pod ä¸­è¿è¡Œå·¥ä½œè´Ÿè½½ä¸ç›´æ¥å¯¹åº”çš„è¡Œä¸ºï¼Œå¯¹äºåŸºäº Pod çš„é›†ç¾¤å·¥ä½œè´Ÿè½½ï¼Œä½ åº”è¯¥ä½¿ç”¨ TaskRunã€‚

ä¸ºäº†è®© `Run` å®é™…æ‰§è¡Œï¼Œå¿…é¡»æœ‰ä¸€ä¸ªè‡ªå®šä¹‰ä»»åŠ¡æ§åˆ¶å™¨åœ¨é›†ç¾¤ä¸Šè¿è¡Œï¼Œè´Ÿè´£ç›‘è§†å’Œæ›´æ–°å¼•ç”¨å…¶ç±»å‹çš„ `Run`ã€‚å¦‚æœæ²¡æœ‰è¿™æ ·çš„æ§åˆ¶å™¨æ­£åœ¨è¿è¡Œï¼Œåˆ™ `Runs` å°†æ²¡æœ‰ `.status` å€¼ã€‚

è‡ªå®šä¹‰ä»»åŠ¡èµ„æºçš„ `Spec` å¯ä»¥ç›´æ¥åµŒå…¥åˆ° `Run` ä¸­ï¼Œä¹Ÿå¯ä»¥ç”± `Ref` å¼•ç”¨ï¼Œä½†æ˜¯ï¼Œä¸èƒ½åŒæ—¶ä½¿ç”¨ä¸¤è€…ã€‚

è¦æŒ‡å®šè¦åœ¨ Run ä¸­æ‰§è¡Œçš„è‡ªå®šä¹‰ä»»åŠ¡ç±»å‹ï¼Œè¯·ä½¿ç”¨ ref å­—æ®µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    
    
    spec:
      ref:
        apiVersion: example.dev/v1alpha1
        kind: Example
    
