# é…ç½®æ–‡ä»¶

[ ](https://github.com/cnych/qikqiak.com/edit/master/docs/logging/loki/config.md "ç¼–è¾‘æ­¤é¡µ")

# é…ç½®æ–‡ä»¶

Loki çš„é…ç½®æ–‡ä»¶éå¸¸å¤æ‚ï¼Œé…ç½®èµ·æ¥æœ‰ä¸€å®šéš¾åº¦ï¼Œæ‰€ä»¥æˆ‘ä»¬éå¸¸æœ‰å¿…è¦å¯¹ Loki é…ç½®æ–‡ä»¶è¿›è¡Œä¸“é—¨çš„åˆ†æã€‚Loki é…ç½®æ–‡ä»¶ `loki.yaml` æ”¯æŒçš„å†…å®¹å’Œé»˜è®¤å€¼æ•°æ®ï¼š
    
    
    # ç”¨é€—å·åˆ†éš”ç»„ä»¶åˆ—è¡¨è¿è¡Œï¼Œé»˜è®¤çš„å€¼ all è¿è¡Œ Loki åœ¨å•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚
    # å€¼ read æ˜¯ä¸€ä¸ªåˆ«åï¼Œç”¨äºä»…åœ¨åŒä¸€è¿›ç¨‹ä¸­è¿è¡Œä¸è¯»å–è·¯å¾„ç›¸å…³çš„ç»„ä»¶ï¼Œå¦‚ querier å’Œ query-frontendã€‚
    # å€¼ write åŒæ ·æ˜¯ä¸€ä¸ªåˆ«åï¼Œç”¨äºä»…åœ¨åŒä¸€è¿›ç¨‹ä¸­è¿è¡Œä¸å†™è·¯å¾„ç›¸å…³çš„ç»„ä»¶ï¼Œå¦‚ ingester å’Œ distributorã€‚
    # æ”¯æŒçš„å€¼åŒ…æ‹¬ï¼šall, compactor, distributor, ingester, querier, query-scheduler,
    #  ingester-querier, query-frontend, index-gateway, ruler, table-manager, read, writeã€‚
    # å½“ä½¿ç”¨ `-list-target` å‘½ä»¤è¡Œæ ‡å¿—è¿è¡Œ Loki æ—¶ï¼Œå¯ä»¥æ‰“å°å¯ç”¨ç›®æ ‡çš„å®Œæ•´åˆ—è¡¨ã€‚
    [target: <string> | default = "all"]
    
    # é€šè¿‡ X-Scope-OrgID Header å¯ç”¨èº«ä»½éªŒè¯ï¼Œå¦‚æœä¸º trueï¼Œè¯¥ Header å¿…é¡»å­˜åœ¨ã€‚
    # å¦‚æœä¸º falseï¼ŒOrgID å°†å§‹ç»ˆè®¾ç½®ä¸º "fake"ã€‚
    [auth_enabled: <boolean> | default = true]
    
    [ballast_bytes: <int> | default = 0]
    
    # é…ç½®å·²å¯åŠ¨æœåŠ¡çš„ HTTP å’Œ gRPC æœåŠ¡å™¨é€šä¿¡ã€‚
    [server: <server>]
    
    # é…ç½® distributorã€‚
    [distributor: <distributor>]
    
    # é…ç½® querierï¼Œä»…åœ¨è¿è¡Œæ‰€æœ‰æ¨¡å—æˆ– querier æ—¶é€‚ç”¨ã€‚
    [querier: <querier>]
    
    # query_scheduler å—é…ç½® Loki æŸ¥è¯¢è°ƒåº¦ç¨‹åºã€‚
    # é…ç½®åï¼Œå®ƒå°†ç§Ÿæˆ·æŸ¥è¯¢é˜Ÿåˆ—ä¸æŸ¥è¯¢å‰ç«¯åˆ†ç¦»
    [query_scheduler: <query_scheduler>]
    
    # é…ç½® Loki query-frontend æ¨¡å—
    [frontend: <frontend>]
    
    # åœ¨ Loki query-frontend é…ç½®æŸ¥è¯¢åˆ†å‰²å’Œç¼“å­˜ã€‚
    [query_range: <query_range>]
    
    # é…ç½® Loki ruler æ¨¡å—
    [ruler: <ruler>]
    
    # é…ç½® distributor å¦‚ä½•è¿æ¥åˆ° ingesterã€‚
    # ä»…åœ¨è¿è¡Œæ‰€æœ‰ç»„ä»¶ã€distributor æˆ– querier æ—¶é€‚ç”¨ã€‚
    [ingester_client: <ingester_client>]
    
    # é…ç½® ingester ä»¥åŠ ingester å¦‚ä½•å°†è‡ªå·±æ³¨å†Œåˆ° kv å­˜å‚¨ã€‚
    [ingester: <ingester>]
    
    # é…ç½® Loki å­˜å‚¨æ•°æ®çš„åœ°æ–¹
    [storage_config: <storage_config>]
    
    # é…ç½® Loki åœ¨æŒ‡å®šçš„å­˜å‚¨ä¸­å¦‚ä½•å­˜å‚¨æ•°æ®
    [chunk_store_config: <chunk_store_config>]
    
    # é…ç½® chunk ç´¢å¼• schema å’Œå­˜å‚¨çš„ä½ç½®
    [schema_config: <schema_config>]
    
    # é…ç½® compactor ç»„ä»¶ï¼Œè¯¥ç»„ä»¶å‹ç¼©ç´¢å¼•åˆ†ç‰‡ä»¥æé«˜æ€§èƒ½
    [compactor: <compactor>]
    
    # é…ç½®æ¯ä¸ªç§Ÿæˆ·æˆ–å…¨å±€çš„é™åˆ¶
    [limits_config: <limits_config>]
    
    # é…ç½®åœ¨ Loki querier ä¸­è¿è¡Œçš„ worker - æ‹¾å–å¹¶æ‰§è¡ŒæŸ¥è¯¢å‰ç«¯æ’é˜Ÿçš„æŸ¥è¯¢ã€‚
    [frontend_worker: <frontend_worker>]
    
    # é…ç½®ç”¨äºä¿ç•™çš„ table managerã€‚
    [table_manager: <table_manager>]
    
    # é…ç½® runtime config æ¨¡å—ï¼Œè´Ÿè´£é‡æ–°åŠ è½½è¿è¡Œæ—¶é…ç½®æ–‡ä»¶ã€‚
    [runtime_config: <runtime_config>]
    
    # é…ç½® tracing
    [tracing: <tracing>]
    
    # å¤šä¸ªæ¨¡å—ä¹‹é—´å…±äº«çš„é€šç”¨é…ç½®ã€‚
    # å¦‚æœåœ¨å…¶ä»–éƒ¨åˆ†ä¸­ç»™å‡ºäº†æ›´å…·ä½“çš„é…ç½®ï¼Œåˆ™å°†å¿½ç•¥æ­¤éƒ¨åˆ†ä¸­çš„ç›¸å…³é…ç½®ã€‚
    [common: <common>]
    
    # ä½¿ç”¨æƒ…å†µæŠ¥å‘Šçš„é…ç½®
    [analytics: <analytics>]
    

è¿™é‡Œæˆ‘ä»¬ä¸»è¦ä»‹ç»å‡ ä¸ªæ ¸å¿ƒçš„é…ç½®å—ã€‚

## common

é€šç”¨é…ç½®å— `common` æ˜¯ç”±ä¸åŒç»„ä»¶å…±äº«çš„å…¬å…±å®šä¹‰ï¼Œè¿™æ ·ï¼Œå°±ä¸å¿…åœ¨å¤šä¸ªåœ°æ–¹é‡å¤é…ç½®äº†ï¼Œä¸‹é¢æ˜¯è¯¥é…ç½®å—çš„ç›¸å…³å±æ€§ï¼š
    
    
    # ä¸åŒ Loki ç»„ä»¶ä½¿ç”¨çš„å…¬å…±å­˜å‚¨é…ç½®
    [storage: <storage>]
    
    # å®šä¹‰åï¼ŒæŒ‡å®šå‰ç¼€å°†å‡ºç°åœ¨ç«¯ç‚¹è·¯å¾„çš„å‰é¢
    [path_prefix: <string>]
    
    # ä¼ å…¥çš„æ•°æ®åº”è¯¥è¢«å¤åˆ¶åˆ° ingester ç»„ä»¶å¤šå°‘æ¬¡
    [replication_factor: <int> | default = 3]
    
    # å¦‚æœä¸º trueï¼Œåˆ™ ingesterã€compactor å’Œ query_scheduler çš„ ring tokens å°†ä¿å­˜åˆ° path_prefix ç›®å½•ä¸­çš„æ–‡ä»¶ä¸­ã€‚å¦‚æœå°†å…¶è®¾ç½®ä¸º true ä¸” path_prefix å‰ç¼€ä¸ºç©ºï¼ŒLoki å°†å‡ºé”™ã€‚
    [persist_tokens: <boolean>: default = false]
    
    # ç”¨äºå†…éƒ¨æŸ¥æ‰¾åœ°å€çš„é€šç”¨çš„ç½‘ç»œæ¥å£åˆ—è¡¨ã€‚
    # å¦‚æœè®¾ç½®äº†æ›´å…·ä½“çš„ "instance_interface_names"ï¼Œåˆ™å¿½ç•¥æ­¤é€‰é¡¹ã€‚
    # å¦‚æœåœ¨å…¬å…±çš„ ring æ¨¡å—ä¸‹é…ç½®äº† "instance_interface_names"ï¼Œåˆ™è¯¥é€šç”¨é…ç½® "instance_interface_names" åªé€‚ç”¨äºå‰ç«¯ï¼Œè€Œä¸é€‚ç”¨äºä¸ ring ç›¸å…³çš„ç»„ä»¶ï¼ˆæ¯”å¦‚ï¼šdistributorã€ruler ç­‰ç­‰ï¼‰
    [instance_interface_names: <list of string> | default = [<private network interfaces>]]
    
    # Loki ç»„ä»¶ç”¨äºæš´éœ²å…¶åœ°å€çš„å…¬å…±åœ°å€ã€‚
    # å¦‚æœé…ç½®äº†æ›´å…·ä½“çš„ "instance_addr" åœ°å€ï¼Œè¯¥é…ç½®ä¼šè¢«å¿½ç•¥ã€‚
    # å¦‚æœ "instance_addr" åœ¨å…¬å…± ring éƒ¨åˆ†ä¸‹é…ç½®äº†ï¼Œåˆ™è¯¥é€šç”¨ "instance_addr" é…ç½®åªé€‚ç”¨äºå‰ç«¯ï¼Œè€Œä¸é€‚ç”¨äºä¸ ring ç›¸å…³çš„ç»„ä»¶ï¼ˆæ¯”å¦‚ï¼šdistributorã€ruler ç­‰ç­‰ï¼‰ã€‚
    [instance_addr: <string>]
    
    # æ‰€æœ‰ Loki rings ä½¿ç”¨çš„é€šç”¨ ring é…ç½®ã€‚
    # å¦‚æœæŒ‡å®šäº†é€šç”¨çš„ ring ç¯ï¼Œåˆ™å…¶å€¼ç”¨äºå®šä¹‰ä»»ä½•æœªå®šä¹‰çš„ ring å€¼ã€‚
    # ä¾‹å¦‚ï¼Œä½ å¯ä»¥æœŸæœ› distributor çš„ ring ç¯ä½¿ç”¨å…¬å…±éƒ¨åˆ†ä¸­å®šä¹‰çš„ `heartbeat_period`ï¼Œä½†å‰ææ˜¯ distributor çš„ ring æœ¬èº«æ²¡æœ‰é…ç½® `heartbeat_period`ã€‚
    [ring: <ring>]
    

ä¸Šé¢çš„é€šç”¨é…ç½®å—ä¸­æœ‰ä¸€ä¸ª `storage` çš„é…ç½®é¡¹ï¼Œç”¨æ¥å®šä¹‰ Loki ä¸åŒç»„ä»¶ä½¿ç”¨çš„å…¬å…±å­˜å‚¨é…ç½®ã€‚å¦‚æœåœ¨é…ç½®æ–‡ä»¶çš„å…¶ä»–ä½ç½®æä¾›äº†å¯¹è±¡å­˜å‚¨å®¢æˆ·ç«¯çš„ä»»ä½•ç‰¹å®šé…ç½®ï¼Œåˆ™è¯¥ç‰¹å®šé…ç½®å°†å–ä»£é€šç”¨å­˜å‚¨é…ç½®ï¼Œå¯¹åº”çš„å±æ€§å¦‚ä¸‹æ‰€ç¤ºï¼š
    
    
    # azure é…ç½®
    [azure: <azure_storage_config>]
    
    # gcs é…ç½®
    [gcs: <gcs_storage_config>]
    
    # s3 é…ç½®
    [s3: <s3_storage_config>]
    
    # swift é…ç½®
    [swift: <swift_storage_config>]
    
    # é…ç½®ä¸€ä¸ªï¼ˆæœ¬åœ°ï¼‰æ–‡ä»¶ç³»ç»Ÿ
    [filesystem: <filesystem>]
    
    [hedging: <hedging_config>]
    

## storage_config

Loki çš„å­˜å‚¨å¼•æ“é…ç½®ï¼Œè¿™ä¸ªé…ç½®å—é‡Œé¢ä¸»è¦å®šä¹‰çš„æ˜¯å„ç±»å­˜å‚¨çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    
    
    # åœ¨ AWS ä¸­çš„ chunks å­˜å‚¨çš„é…ç½®ã€‚å¿…éœ€çš„é€‰é¡¹åªæœ‰åœ¨ aws å‡ºç°æ—¶æ‰éœ€è¦ã€‚
    aws:
      # S3 æˆ– S3 å…¼å®¹çš„ endpoint URL åœ°å€ï¼Œå¸¦æœ‰ç¼–ç çš„ Key å’Œ Secretã€‚
      # å¦‚æœä»…å°† region é…ç½®ä¸ºä¸»æœºï¼Œåˆ™å°†æ¨æ–­å‡ºæ­£ç¡®çš„ç«¯ç‚¹ã€‚
      # CLI flag: -s3.url
      [s3: <string>]
    
      # è®¾ç½®ä¸º true å¯å¼ºåˆ¶è¯·æ±‚ä½¿ç”¨ path-style å¯»å€
      # CLI flag: -s3.force-path-style
      [s3forcepathstyle: <boolean> | default = false]
    
      # ä»¥é€—å·åˆ†éš”çš„ buckets åç§°åˆ—è¡¨ï¼Œç”¨äºå‡åŒ€åˆ†å¸ƒ chunksã€‚
      # åœ¨ s3.url æ ‡å¿—ä¸­è¦†ç›–ä»»æ„çš„ buckets
      # CLI flag: -s3.buckets
      [bucketnames: <string> | default = ""]
    
      # è¿æ¥çš„ S3 Endpoint
      # CLI flag: -s3.endpoint
      [endpoint: <string> | default = ""]
    
      # AWS ä½¿ç”¨çš„åŒºåŸŸ
      # CLI flag: -s3.region
      [region: <string> | default = ""]
    
      # AWS Access Key ID.
      # CLI flag: -s3.access-key-id
      [access_key_id: <string> | default = ""]
    
      # AWS Secret Access Key.
      # CLI flag: -s3.secret-access-key
      [secret_access_key: <string> | default = ""]
    
      # ç¦ç”¨ https
      # CLI flag: -s3.insecure
      [insecure: <boolean> | default = false]
    
      # å¯ç”¨ AES256 AWS æœåŠ¡å™¨ç«¯åŠ å¯†
      # CLI flag: -s3.sse-encryption
      [sse_encryption: <boolean> | default = false]
    
      # ... çœç•¥å…¶ä»–é…ç½®
    
      # é…ç½® DynamoDB è¿æ¥
      dynamodb:
        # DynamoDB URL åœ°å€
        # CLI flag: -dynamodb.url
        dynamodb_url: <string>
        # ...... çœç•¥ dynamodb é…ç½®
    
    # åœ¨ Bigtable ä¸­é…ç½®å­˜å‚¨ç´¢å¼•ã€‚åªæœ‰åœ¨é…ç½®ä¸­å®šä¹‰äº† bigtable æ—¶ï¼Œæ‰éœ€è¦å¿…å¡«å­—æ®µã€‚
    bigtable:
      # BigTable project ID
       # CLI flag: -bigtable.project
      project: <string>
    
      # BigTable instance ID
      # CLI flag: -bigtable.instance
      instance: <string>
    
      # é…ç½®è¿æ¥åˆ° Bigtable çš„ gRPC å®¢æˆ·ç«¯
      [grpc_client_config: <grpc_client_config>]
    
    # é…ç½®å­˜å‚¨ chunks åœ¨ GCS ä¸­ï¼Œåªæœ‰åœ¨é…ç½®ä¸­å®šä¹‰äº† gcs æ—¶æ‰éœ€è¦è¯¥å­—æ®µ
    gcs:
      # è¦æ”¾å…¥ chunks çš„ GCS å­˜å‚¨æ¡¶çš„åç§°ã€‚
      # CLI flag: -gcs.bucketname
      bucket_name: <string>
    
      # GCSå®¢æˆ·ç«¯ç”¨äºæ¯ä¸ª PUT è¯·æ±‚çš„ç¼“å†²åŒºå¤§å°ï¼Œ0è¡¨ç¤ºç¦ç”¨ bufferã€‚
      # to disable buffering.
      # CLI flag: -gcs.chunk-buffer-size
      [chunk_buffer_size: <int> | default = 0]
    
      # å¯¹ GCS çš„è¯·æ±‚è¶…æ—¶çš„æ—¶é—´ã€‚
      # CLI flag: -gcs.request-timeout
      [request_timeout: <duration> | default = 0s]
    
    # åœ¨ Cassandra ä¸­å­˜å‚¨ chunks å’Œ/æˆ– ç´¢å¼•çš„é…ç½®
    cassandra:
      # ç”¨é€—å·åˆ†éš”çš„ Cassandra å®ä¾‹çš„ä¸»æœºåæˆ– IPs
      # CLI flag: -cassandra.addresses
      addresses: <string>
      # cassandra ç«¯å£
      # CLI flag: -cassandra.port
      [port: <int> | default = 9042]
    
      # ...... çœç•¥
    
    swift:
    #   ...... çœç•¥
    
    # å­˜å‚¨ç´¢å¼•åœ¨ BoltDB ä¸­çš„é…ç½®ã€‚
    boltdb:
      # BoltDB ç´¢å¼•æ–‡ä»¶è·¯å¾„
      # CLI flag: -boltdb.dir
      directory: <string>
    
    # å­˜å‚¨ chunks åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
    filesystem:
      # chunks å­˜å‚¨çš„è·¯å¾„
      # CLI flag: -local.chunk-directory
      directory: <string>
    
    # ä»¥ boltdb æ–‡ä»¶çš„å½¢å¼åœ¨å¯¹è±¡å­˜å‚¨ï¼ˆGCS/S3/Azure/Swift/Filesystemï¼‰ä¸­é…ç½®å­˜å‚¨ç´¢å¼•ã€‚
    boltdb_shipper:
      # ingesters å°†æ•°æ®å†™å…¥ boltdb æ–‡ä»¶çš„ç›®å½•ï¼Œç„¶åç”± shipper ä¸Šä¼ åˆ°é…ç½®çš„å­˜å‚¨ä¸­
      # CLI flag: -boltdb.shipper.active-index-directory
      [active_index_directory: <string> | default = ""]
    
      # ç”¨äºä¿å­˜ boltdb æ–‡ä»¶çš„å…±äº«å­˜å‚¨ï¼Œæ”¯æŒçš„ç±»å‹æœ‰ï¼šgcsã€s3ã€azureã€filesystem
      # CLI flag: -boltdb.shipper.shared-store
      [shared_store: <string> | default = ""]
    
      # ç”¨äºæ¢å¤æŸ¥è¯¢çš„ boltDB æ–‡ä»¶çš„ç¼“å­˜ä½ç½®
      # CLI flag: -boltdb.shipper.cache-location
      [cache_location: <string> | default = ""]
    
      # æŸ¥è¯¢ç¼“å­˜ä¸­æ¢å¤çš„ boltDB æ–‡ä»¶çš„ TTL
      # CLI flag: -boltdb.shipper.cache-ttl
      [cache_ttl: <duration> | default = 24h]
    
      # å°†ä¸‹è½½çš„æ–‡ä»¶ä¸å­˜å‚¨é‡æ–°åŒæ­¥çš„é¢‘ç‡
      # CLI flag: -boltdb.shipper.resync-interval
      [resync_interval: <duration> | default = 5m]
    
      # ä¸ºæŸ¥è¯¢ä¿ç•™ä¸‹è½½ç´¢å¼•çš„å¤©æ•°ï¼Œä»…é€‚ç”¨äºä»¥24å°æ—¶å‘¨æœŸåˆ›å»ºçš„è¡¨ã€‚
      # CLI flag: -boltdb.shipper.query-ready-num-days
      [query_ready_num_days: <int> | default = 0]
    
      index_gateway_client:
        # Index Gateway gRPC æœåŠ¡åœ°å€
        # CLI flag: -boltdb.shipper.index-gateway-client.server-address
        [server_address: <string> | default = ""]
        # è¿æ¥ Index Gateway gRPC æœåŠ¡çš„ gRPC å®¢æˆ·ç«¯
        [grpc_client_config: <grpc_client_config>]
    
    # æ´»è·ƒç´¢å¼•çš„ç¼“å­˜æœ‰æ•ˆæœŸï¼Œä¸åº”é«˜äº ingester è®¾ç½®ä¸­çš„ `chunk_idle_period`ã€‚
    # CLI flag: -store.index-cache-validity
    [index_cache_validity: <duration> | default = 5m]
    
    # æ¯æ‰¹è·å–çš„æœ€å¤§ chunks æ•°ã€‚
    # CLI flag: -store.max-chunk-batch-size
    [max_chunk_batch_size: <int> | default = 50]
    
    # é…ç½®å¦‚ä½•æ„å»ºç´¢å¼•æŸ¥è¯¢çš„ç¼“å­˜ã€‚
    index_queries_cache_config: <cache_config>
    

## distributor

`distributor` é…ç½®å—ç”¨äºé…ç½® distributor ç»„ä»¶ï¼Œè¯¥é…ç½®å—å¯¹åº”çš„å±æ€§æœ‰ï¼š
    
    
    # é…ç½® distributors ringï¼Œåœ¨å¯ç”¨ "global" æ‘„å–ç‡ç­–ç•¥æ—¶ä½¿ç”¨ã€‚
    ring:
      kvstore:
        # ring ä½¿ç”¨çš„åç«¯å­˜å‚¨ï¼Œæ”¯æŒçš„å€¼åŒ…æ‹¬ï¼šconsulã€etcdã€inmemoryã€memberlist
        # memberlist ä½¿ç”¨çš„æ˜¯ gossip åè®®æ¥è®©é›†ç¾¤å†…çš„æ‰€æœ‰èŠ‚ç‚¹è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§çš„
        # CLI flag: -distributor.ring.store
        store: <string>
    
        # å­˜å‚¨ä¸­ key çš„å‰ç¼€ï¼Œ åº”ä»¥ `/` ç»“å°¾ã€‚
        # CLI flag: -distributor.ring.prefix
        [prefix: <string> | default = "collectors/"]
    
        # Consul å®¢æˆ·ç«¯é…ç½®ï¼Œåªæœ‰å½“ store é…ç½®ä¸º `consul` çš„æ—¶å€™æ‰é€‚ç”¨
        # æ­¤å—é…ç½®çš„ CLI æ ‡å¿—å‰ç¼€ä¸ºï¼šdistributor.ring
        [consul: <consul_config>]
    
        # ETCD v3 å®¢æˆ·ç«¯é…ç½®ï¼Œåªæœ‰å½“ store é…ç½®ä¸º `etcd` çš„æ—¶å€™æ‰é€‚ç”¨
        # æ­¤å—é…ç½®çš„ CLI æ ‡å¿—å‰ç¼€ä¸ºï¼šdistributor.ring
        [etcd: <etcd_config>]
    
      # å¿ƒè·³è¶…æ—¶ï¼Œåœ¨æ­¤è¶…æ—¶ä¹‹åï¼Œring å†…çš„ distributor è¢«è§†ä¸ºä¸å¥åº·ï¼Œ0è¡¨ç¤ºnever
      # CLI flag: -distributor.ring.heartbeat-timeout
      [heartbeat_timeout: <duration> | default = 1m]
    

## ingester

`ingester` é…ç½®å—ç”¨äºé…ç½® loki ingester ç»„ä»¶ï¼Œè¯¥é…ç½®å—å¯¹åº”çš„å±æ€§æœ‰ï¼š
    
    
    # é…ç½® ingester çš„ç”Ÿå‘½å‘¨æœŸ - å°†å¦‚ä½•è¿è¡Œä»¥åŠåœ¨ä½•å¤„æ³¨å†Œä»¥è¿›è¡Œå‘ç°ã€‚
    lifecycler:
      ring:
        kvstore:
          # ring ä½¿ç”¨çš„åç«¯å­˜å‚¨ï¼Œæ”¯æŒçš„å€¼åŒ…æ‹¬ï¼šconsulã€etcdã€inmemoryã€memberlist
          # CLI flag: -ring.store
          [store: <string> | default = "consul"]
    
          # å­˜å‚¨ä¸­ key çš„å‰ç¼€ï¼Œ åº”ä»¥ `/` ç»“å°¾ã€‚
          # CLI flag: -ring.prefix
          [prefix: <string> | default = "collectors/"]
    
          # consul å®¢æˆ·ç«¯é…ç½®
          # CLI flag: <no prefix>
          [consul: <consul_config>]
    
          # etcd å®¢æˆ·ç«¯é…ç½®
          # CLI flag: <no prefix>
          [etcd: <etcd_config>]
    
        # å¿ƒè·³ğŸªåå°†è·³è¿‡ ingesters çš„è¯»/å†™æ“ä½œã€‚
        # CLI flag: -ring.heartbeat-timeout
        [heartbeat_timeout: <duration> | default = 1m]
    
        # è¦å†™å…¥å’Œè¯»å–çš„ ingesters æ•°ã€‚
        # CLI flag: -distributor.replication-factor
        [replication_factor: <int> | default = 3]
    
      # lifecycler å°†ç”Ÿæˆå¹¶æ”¾å…¥ ring ä¸­çš„ tokens æ•°
      # å¦‚æœå®ƒåŠ å…¥ ring è€Œä¸ä»å¦ä¸€ä¸ª lifecycler è½¬ç§» tokenã€‚
      # CLI flag: -ingester.num-tokens
      [num_tokens: <int> | default = 128]
    
      # åº•å±‚ ring çš„å¿ƒè·³å‘¨æœŸ
      # CLI flag: -ingester.heartbeat-period
      [heartbeat_period: <duration> | default = 5s]
    
      # å½“å¦ä¸€ä¸ªæˆå‘˜ç¦»å¼€æ—¶ï¼Œè¦ç­‰å¾…å¤šé•¿æ—¶é—´æ‰èƒ½ä»å¦å¤–æˆå‘˜å¤„å£°æ˜ tokens å’Œ chunksã€‚å°†åœ¨åˆ°æœŸåè‡ªåŠ¨åŠ å…¥ã€‚
      # CLI flag: -ingester.join-after
      [join_after: <duration> | default = 0s]
    
      # ç”Ÿæˆåè§‚å¯Ÿ tokens ä»¥è§£å†³å†²çªã€‚å½“ä½¿ç”¨ gossip ring çš„æ—¶å€™éå¸¸æœ‰ç”¨
      # CLI flag: -ingester.observe-period
      [observe_period: <duration> | default = 0s]
    
      # å‡†å¤‡å°±ç»ªå‰çš„æœ€çŸ­ç­‰å¾…æ—¶é—´ã€‚è¿™æ˜¯ä¸ºäº†è§£å†³ ingesters é€€å‡ºå’Œæ›´æ–°ç¯çš„ race conditionsã€‚
      # CLI flag: -ingester.min-ready-duration
      [min_ready_duration: <duration> | default = 15s]
    
      # è¦ä»ä¸­è¯»å–åœ°å€çš„ç½‘ç»œæ¥å£çš„åç§°ã€‚
      # CLI flag: -ingester.lifecycler.interface
      interface_names:
        - [<string> ... | default = [<private network interfaces>]]
    
      # é€€å‡ºå‰çš„ sleep æ—¶é—´ï¼Œä»¥ç¡®ä¿æŒ‡æ ‡è¢«æ­£å¸¸æŠ“å–ã€‚
      # CLI flag: -ingester.final-sleep
      [final_sleep: <duration> | default = 30s]
    
    # æœ€å¤§è½¬ç§» chunks é‡è¯•æ¬¡æ•°
    # CLI flag: -ingester.max-transfer-retries
    [max_transfer_retries: <int> | default = 0]
    
    # flush æ“ä½œå¹¶å‘æ•°
    # CLI flag: -ingester.concurrent-flushes
    [concurrent_flushes: <int> | default = 32]
    
    # ingester åº”å¤šä¹…æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æœ‰æ•°æ®å µå¡éœ€è¦ flush
    # CLI flag: -ingester.flush-check-period
    [flush_check_period: <duration> | default = 30s]
    
    # flushè¢«å–æ¶ˆå‰çš„è¶…æ—¶æ—¶é—´
    # CLI flag: -ingester.flush-op-timeout
    [flush_op_timeout: <duration> | default = 10m]
    
    # flush chunk åï¼Œåº”åœ¨å†…å­˜ä¸­ä¿ç•™å¤šé•¿æ—¶é—´ã€‚
    # CLI flag: -ingester.chunks-retain-period
    [chunk_retain_period: <duration> | default = 0s]
    
    # å¦‚æœ chunk æ²¡æœ‰è¾¾åˆ°æœ€å¤§å—å¤§å°ï¼Œåˆ™åœ¨åˆ·æ–°ä¹‹å‰ï¼Œchunk åº”è¯¥åœ¨å†…å­˜ä¸­ä¿ç•™å¤šé•¿æ—¶é—´ï¼Œå¹¶ä¸”æ²¡æœ‰æ›´æ–°ã€‚
    # è¿™æ„å‘³ç€ï¼Œåªè¦ half-empty çš„ chunks æ²¡æœ‰æ¥æ”¶åˆ°è¿›ä¸€æ­¥çš„å†…å®¹ï¼Œå®ƒä»¬åœ¨æŸä¸ªæ—¶é—´æ®µä¹‹åä»å°†è¢«åˆ·æ–°ã€‚
    # CLI flag: -ingester.chunks-idle-period
    [chunk_idle_period: <duration> | default = 30m]
    
    # ä¸€ä¸ª chunk block æœªå‹ç¼©çš„å¤§å°
    # å½“è¶…è¿‡è¯¥é˜ˆå€¼åï¼Œhead block ä¼šè¢«è£å‰ªå¹¶å‹ç¼©åˆ° chunk ä¸­å»ã€‚
    # CLI flag: -ingester.chunks-block-size
    [chunk_block_size: <int> | default = 262144]
    
    # chunks å‹ç¼©åçš„å¤§å°
    # è¿™æ˜¯ä¸€ä¸ªç†æƒ³çš„å¤§å°ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç¡®åˆ‡çš„å¤§å°ï¼Œå¦‚æœå› ä¸ºå…¶ä»–åŸå› ï¼ˆæ¯”å¦‚ chunk_idle_periodï¼‰è¢« flushï¼Œchunks å¯èƒ½ä¼šç¨å¾®å¤§ä¸€äº›æˆ–è€…æ˜æ˜¾å°ä¸€äº›ã€‚
    # å€¼ä¸º0æ—¶ï¼Œå°†åˆ›å»ºå›ºå®š10ä¸ªblocksçš„å—ï¼Œé0å€¼å°†åˆ›å»ºå…·æœ‰å¯å˜ blocks çš„å—ï¼Œä»¥æ»¡è¶³ç›®æ ‡å¤§å°ã€‚
    # CLI flag: -ingester.chunk-target-size
    [chunk_target_size: <int> | default = 1572864]
    
    # chunksçš„å‹ç¼©ç®—æ³•(æ”¯æŒçš„å€¼: gzip, lz4, snappy)
    # æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç®—æ³•:
    # - `gzip` æœ€é«˜çš„å‹ç¼©ç‡ä½†æ˜¯ä¹Ÿæ˜¯æœ€æ…¢çš„å‹ç¼©é€Ÿåº¦ (144 kB/chunk)
    # - `lz4` æœ€å¿«çš„å‹ç¼©é€Ÿåº¦ (188 kB/chunk)
    # - `snappy` å¿«é€Ÿæµè¡Œçš„å‹ç¼©ç®—æ³• (272 kB/chunk)
    # CLI flag: -ingester.chunk-encoding
    [chunk_encoding: <string> | default = gzip]
    
    # ç”¨äºåŒæ­¥ ingesters ä»¥åŒæ—¶åˆ‡å‰² chunks çš„å‚æ•°ã€‚
    # åŒæ­¥å‘¨æœŸç”¨äºå°†ä¼ å…¥æ¡ç›®æ»šåŠ¨åˆ°æ–°çš„ chunkï¼Œå¦‚æœ chunk çš„åˆ©ç”¨ç‡ä¸å¤Ÿé«˜ï¼ˆä¾‹å¦‚ å½“ sync_min_utilization è¢«è®¾ç½®ä¸º0.5ï¼Œå°äº50%ï¼‰ï¼Œé‚£ä¹ˆ chunk çš„æ»šåŠ¨å°±ä¸ä¼šå‘ç”Ÿã€‚
    # CLI flag: -ingester.sync-period
    [sync_period: <duration> | default = 0]
    
    # æœ€å°çš„åŒæ­¥åˆ©ç”¨ç‡
    # CLI flag: -ingester.sync-min-utilization
    [sync_min_utilization: <float> | Default = 0]
    
    # å½“ push å¤±è´¥åï¼Œæµå°†å‘ç”¨æˆ·æŠ¥å‘Šçš„æœ€å¤§é”™è¯¯æ•°ï¼Œ0è¡¨ç¤ºæ²¡é™åˆ¶ã€‚
    # CLI flag: -ingester.max-ignored-stream-errors
    [max_returned_stream_errors: <int> | default = 10]
    
    # å†…å­˜ä¸­ timeseries chunk çš„æœ€å¤§æŒç»­æ—¶é—´ã€‚
    # å¦‚æœä¸€ä¸ª timeseries è¿è¡Œæ—¶é—´è¶…è¿‡è¯¥å€¼ï¼Œå½“å‰ chunk å°†åˆ·æ–°åˆ°å­˜å‚¨ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°åŒºå—ã€‚
    # CLI flag: -ingester.max-chunk-age
    [max_chunk_age: <duration> | default = 2h]
    
    # è¿‡å»å¤šé•¿æ—¶é—´ ingester å¯ä»¥æŸ¥è¯¢å­˜å‚¨ä¸­çš„æ•°æ®ã€‚
    # è¿™åªé€‚ç”¨äºä½¿ç”¨ `filesystem` å­˜å‚¨çš„å…±äº« ring è¿è¡Œçš„å¤šä¸ª Loki äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸ä¼šåœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¹‹é—´å…±äº«ã€‚
    # å½“ä½¿ç”¨ä»»ä½•å…±äº«å­˜å‚¨æ¯”å¦‚S3ã€GCSçš„æ—¶å€™ï¼Œè¯¥å€¼å¿…é¡»è®¾ç½®ä¸º0ã€‚
    # ä½¿ç”¨é™¤ `filesystem` ä»¥å¤–çš„ä»»ä½•å¯¹è±¡å­˜å‚¨æ—¶ï¼Œå°†å…¶é…ç½®ä¸ºéé›¶å€¼æ˜¯é”™è¯¯çš„ã€‚
    # ä½¿ç”¨å€¼ -1 å…è®¸ ingester åœ¨æ—¶é—´ä¸Šæ— é™è¿œåœ°æŸ¥è¯¢å­˜å‚¨ã€‚
    # CLI flag: -ingester.query-store-max-look-back-period
    [query_store_max_look_back_period: <duration> | default = 0]
    
    # å¿˜è®° ingesters çš„å¿ƒè·³æ—¶é—´æˆ³ï¼Œæ¯” `ring.kvstore.heartbeat_timeout` è¿˜è¦æ—©ã€‚
    # è¿™ç›¸å½“äºå•å‡»UIä¸­çš„`/ring`ã€`forget` æŒ‰é’®ï¼š
    # ingester å°†ä¼šä» ring ä¸­ç§»å‡ºæ‰ã€‚
    # å½“ä½ ç¡®å®šä¸å¥åº·çš„èŠ‚ç‚¹ä¸ä¼šè¿”å›æ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„è®¾ç½®ã€‚
    # ä¸€ä¸ªç¤ºä¾‹æ˜¯å½“ä¸ä½¿ç”¨æœ‰çŠ¶æ€é›†æ—¶ã€‚
    # ä½¿ç”¨ `memberlist.rejoin_interval` > 0 æ¥å¤„ç†ç½‘ç»œåˆ†åŒºæƒ…å†µå½“ä½¿ç”¨æˆå‘˜åˆ—è¡¨æ—¶ã€‚
    # CLI flag: -ingester.autoforget-unhealthy
    [autoforget_unhealthy: <boolean> | default = false]
    
    # ingester WAL è®°å½•ä¼ å…¥çš„æ—¥å¿—å’Œå­˜å‚¨ä»–ä»¬åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸ºäº†ä¿è¯å·²ç¡®è®¤æ•°æ®çš„æŒä¹…æ€§åœ¨è¿›ç¨‹å´©æºƒçš„æƒ…å†µä¸‹ã€‚
    wal:
      # å¯ç”¨å¯¹ WAL çš„å†™æ“ä½œã€‚
      # CLI flag: -ingester.wal-enabled
      [enabled: <boolean> | default = true]
    
      # WAL æ•°æ®ç›®å½•
      # CLI flag: -ingester.wal-dir
      [dir: <filename> | default = "wal"]
    
      # å¯ç”¨ WAL æ—¶ï¼Œåº”åœ¨å…³æœºæ—¶å°† chunks åˆ·æ–°åˆ°é•¿æœŸå­˜å‚¨ä¸­
      # CLI flag: -ingester.flush-on-shutdown
      [flush_on_shutdown: <boolean> | default = false]
    
      # checkpoints è¢«åˆ›å»ºçš„é—´éš”
      # CLI flag: ingester.checkpoint-duration
      [checkpoint_duration: <duration> | default = 5m]
    
      # WAL åœ¨é‡æ”¾æœŸé—´å¯èƒ½ä½¿ç”¨çš„æœ€å¤§å†…å­˜å¤§å°ã€‚
      # è¾¾åˆ°åï¼Œåœ¨ç»§ç»­ä¹‹å‰å°†æ•°æ®åˆ·æ–°åˆ°å­˜å‚¨ä¸­å»ã€‚
      # å¯ä»¥ä½¿ç”¨çš„å•ä½åç¼€åŒ…æ‹¬ï¼šKBã€MBã€GBã€‚
      [replay_memory_ceiling: <string> | default = 4GB]
    
    # ingesters ä¸­ç”¨äºè¿›ç¨‹å†…å€’æ’ç´¢å¼•çš„åˆ†ç‰‡ã€‚
    # è¿™å¿…é¡»è¢«æ‰€æœ‰ schema ä¸­çš„ shard factors æ•´é™¤ï¼Œå¦åˆ™ Loki å°†ä¸ä¼šå¯åŠ¨ã€‚
    [index_shards: <int> | default = 32]
    

## querier

`querier` é…ç½®å—ç”¨äºé…ç½® querier ç»„ä»¶ï¼ŒåŒ…å«çš„å±æ€§æœ‰ï¼š
    
    
    # åœ¨æ‰§è¡ŒæŸ¥è¯¢è¯·æ±‚æœŸé—´æŸ¥è¯¢ ingesters æˆ–å­˜å‚¨çš„è¶…æ—¶æ—¶é—´ã€‚
    # CLI flag: -querier.query-timeout
    [query_timeout: <duration> | default = 1m]
    
    # ä¸ºå®æ—¶è·Ÿè¸ªè¯·æ±‚æä¾›æœåŠ¡çš„æœ€é•¿æŒç»­æ—¶é—´ã€‚
    # CLI flag: -querier.tail-max-duration
    [tail_max_duration: <duration> | default = 1h]
    
    # å‘é€è¶…è¿‡æœ€å°æˆåŠŸæŸ¥è¯¢è¯·æ±‚ä¹‹å‰çš„ç­‰å¾…æ—¶é—´ã€‚
    # CLI flag: -querier.extra-query-delay
    [extra_query_delay: <duration> | default = 0s]
    
    # æœ€å¤§å›æº¯æœŸï¼Œè¶…è¿‡è¯¥å€¼ï¼ŒæŸ¥è¯¢ä¸ä¼šå‘é€åˆ° ingesterã€‚
    # 0 æ„å‘³ç€æ‰€æœ‰çš„ queries è¢«å‘é€åˆ° ingesterã€‚
    # CLI flag: -querier.query-ingesters-within
    [query_ingesters_within: <duration> | default = 3h]
    
    # å…è®¸çš„æœ€å¤§å¹¶å‘æŸ¥è¯¢æ•°
    # CLI flag: -querier.max-concurrent
    [max_concurrent: <int> | default = 10]
    
    # ä»…æŸ¥è¯¢å­˜å‚¨ä¸­çš„æ•°æ®ï¼Œä¸å°è¯•æŸ¥è¯¢ä»»ä½• ingesters
    # CLI flag: -querier.query-store-only
    [query_store_only: <boolean> | default = false]
    
    # æ˜¯å¦å…è®¸æŸ¥è¯¢å¤šä¸ªç§Ÿæˆ·
    # CLI flag: -querier.multi-tenant-queries-enabled
    [multi_tenant_queries_enabled: <boolean> | default = false]
    
    # LogQL å¼•æ“é…ç½®é€‰é¡¹
    engine:
      # æŸ¥è¯¢æ‰§è¡Œè¶…æ—¶æ—¶é—´
      # CLI flag: -querier.engine.timeout
      [timeout: <duration> | default = 3m]
    
      # æŸ¥æ‰¾æ—¥å¿—è¡Œçš„æœ€é•¿æ—¶é—´ï¼Œä»…é€‚ç”¨äºå³æ—¶æ—¥å¿—æŸ¥è¯¢ã€‚
      # CLI flag: -querier.engine.max-lookback-period
      [max_look_back_period: <duration> | default = 30s]
    

## query_range

ç”¨äºåœ¨ Loki æŸ¥è¯¢å‰ç«¯é…ç½®æŸ¥è¯¢åˆ†å‰²å’Œç¼“å­˜ã€‚
    
    
    # ä¸æ¨è: æŒ‰æ—¥æ‹†åˆ†æŸ¥è¯¢å¹¶è¡Œæ‰§è¡Œã€‚
    # ç”¨ -querier.split-queries-by-interval ä»£æ›¿.
    # CLI flag: -querier.split-queries-by-day
    [split_queries_by_day: <boolean> | default = false]
    
    # å¯¹ä¼ å…¥æŸ¥è¯¢è¿›è¡Œå˜æ›´ï¼Œä½¿å…¶å¼€å§‹å’Œç»“æŸä¸å…¶æ­¥é•¿ä¿æŒä¸€è‡´ã€‚
    # CLI flag: -querier.align-querier-with-step
    [align_queries_with_step: <boolean> | default = false]
    
    results_cache:  # ç¼“å­˜
      cache: <cache_config>
    
    # ç¼“å­˜æŸ¥è¯¢ç»“æœ
    # CLI flag: -querier.cache-results
    [cache_results: <boolean> | default = false]
    
    # å•ä¸ªè¯·æ±‚çš„æœ€å¤§é‡è¯•æ¬¡æ•°
    # CLI flag: -querier.max-retries-per-request
    [max_retries: <int> | default = 5]
    
    # æ ¹æ®å­˜å‚¨åˆ†ç‰‡é…ç½®æ‰§è¡ŒæŸ¥è¯¢å¹¶è¡ŒåŒ–ï¼Œå¹¶æŸ¥è¯¢ASTã€‚æ­¤åŠŸèƒ½ä»…ç”± chunks å­˜å‚¨å¼•æ“æ”¯æŒã€‚
    # CLI flag: -querier.parallelise-shardable-queries
    [parallelise_shardable_queries: <boolean> | default = true]
    

## schema_config

è¿™é‡Œé¢ä¸»è¦å®šä¹‰çš„æ˜¯ Loki æ•°æ®å­˜å‚¨çš„ç­–ç•¥ï¼Œä»é»˜è®¤çš„é…ç½®é‡Œé¢å¯ä»¥å¾—åˆ°çš„ä¿¡æ¯æ˜¯ Loki é‡Œé¢ä¿å­˜çš„æ˜¯2018å¹´4æœˆ15æ—¥ä¹‹åçš„æ•°æ®ï¼ŒåŒæ—¶åŸå§‹æ–‡ä»¶ï¼ˆchunksï¼‰å­˜åœ¨ filesystem ä¸­ï¼Œindex å­˜åœ¨ boltdb å½“ä¸­ä¸”ä¿å­˜çš„å‘¨æœŸæ˜¯168å°æ—¶ã€‚
    
    
    # ç”¨äº chunk ç´¢å¼• schemas é…ç½®
    configs:
    - [<period_config>]
    

å…¶ä¸­å°±åŒ…å«ä¸€ä¸ª `period_config` åˆ—è¡¨ï¼Œè¯¥é…ç½®å—ç”¨äºé…ç½®ä»ç‰¹å®šçš„æ—¶é—´æ®µåº”è¯¥ä½¿ç”¨å“ªäº›ç´¢å¼•æ¨¡å¼ã€‚
    
    
    # åº”è¯¥åˆ›å»ºç´¢å¼• buckets çš„ç¬¬ä¸€å¤©çš„æ—¥æœŸã€‚
    # å¦‚æœè¿™æ˜¯å”¯ä¸€çš„ `period_config`ï¼Œåˆ™ä½¿ç”¨è¿‡å»çš„æ—¥æœŸï¼Œå¦åˆ™åœ¨å¸Œæœ›æ¨¡å¼åˆ‡æ¢æ—¶ä½¿ç”¨æ—¥æœŸã€‚
    # YYYY-MM-DD æ ¼å¼, ä¾‹å¦‚: 2018-04-15.
    [from: <daytime>]
    
    # ä¸‹é¢çš„ store å’Œ object_store ä¼šå†³å®šä½¿ç”¨å“ªä¸ª <storage_config> keyã€‚
    
    # ç”¨äºç´¢å¼•çš„å­˜å‚¨ï¼šawsã€aws-dynamoã€gcpã€bigtableã€bigtable-hashedã€cassandraã€boltdb æˆ–è€… boltdb-shipperã€‚
    store: <string>
    
    # ç”¨äº chunks çš„å­˜å‚¨ï¼šawsã€azureã€gcpã€bigtableã€gcsã€cassandraã€swift æˆ–è€… filesystem
    # å¦‚æœçœç•¥ï¼Œåˆ™é»˜è®¤ä¸ºä¸ store ç›¸åŒçš„å€¼ã€‚
    [object_store: <string>]
    
    # schema ä½¿ç”¨çš„ç‰ˆæœ¬
    schema: <string>
    
    # é…ç½®ç´¢å¼•å¦‚ä½•æ›´æ–°å’Œå­˜å‚¨
    index:
      # æ‰€æœ‰å‘¨æœŸè¡¨çš„è¡¨å‰ç¼€ã€‚
      prefix: <string>
      # Table å‘¨æœŸ.
      [period: <duration> | default = 168h]
      # è¦æ·»åŠ åˆ°æ‰€æœ‰ç®¡ç†çš„è¡¨ä¸­çš„æ ‡ç­¾ã€‚
      tags:
        [<string>: <string> ...]
    
    # é…ç½® chunks çš„æ›´æ–°å’Œå­˜å‚¨æ–¹å¼ã€‚
    chunks:
      prefix: <string>
      [period: <duration> | default = 168h]
      tags:
        [<string>: <string> ...]
    
    # å°†åˆ›å»ºå¤šå°‘ä¸ªåˆ†ç‰‡ã€‚ä»…å½“ schema ä¸º v10 æˆ–æ›´é«˜ç‰ˆæœ¬æ—¶ä½¿ç”¨ã€‚
    [row_shards: <int> | default = 16]
    

Loki å¯¹äºæ•°æ®å­˜å‚¨çš„ç›®æ ‡æ˜¯å‘åå…¼å®¹ï¼Œé€šè¿‡ä¿®æ”¹ Schema é…ç½®å…è®¸ä»¥å¢é‡æ–¹å¼å‡çº§åˆ°æ–°çš„å­˜å‚¨æ¨¡å¼ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨`schema_config` ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ configs æ¡ç›®ï¼Œè¦è®°ä½çš„æ˜¯æ–°åŠ çš„å­˜å‚¨æ¨¡å¼èµ·å§‹æ—¶é—´å¿…é¡»æ˜¯å°†æ¥çš„æŸä¸ªæ—¶é—´ç‚¹ï¼Œè¿™æ · Table Manager å°±å¯ä»¥åœ¨ä¹‹å‰åˆ›å»ºæ‰€éœ€çš„è¡¨ï¼Œå¹¶ç¡®ä¿ä¸ä¼šæŸ¥è¯¢ç°æœ‰æ•°æ®ã€‚å¦åˆ™åœ¨æŸ¥è¯¢æ—¶ä¼šå› ä¸¢å¤±æ—§çš„æ—¥å¿—ç´¢å¼•é€ æˆæ— æ³•æ£€ç´¢ã€‚ä¾‹å¦‚æˆ‘ä»¬è¦æŠŠ2022å¹´6æœˆ18æ—¥ä¹‹åçš„ Loki æ—¥å¿—åˆ‡æ¢åˆ° cassandra å’Œ S3 ä¸Šï¼Œé‚£ä¹ˆæŒ‰ç…§å¦‚ä¸‹é…ç½®åï¼Œé‡å¯æœåŠ¡å³å¯ã€‚
    
    
    schema_config:
      configs:
      - from: 2018-04-15
        store: boltdb
        object_store: filesystem
        schema: v10
        index:
          prefix: index_
          period: 168h
      - from: 2022-06-18
        store: cassandra
        object_store: aws
        schema: v11
        index:
          prefix: index_
          period: 720h
        chunks:
          prefix: chunks_
          period: 720h
    storage_config:
      boltdb:
        directory: /data/loki/index
      filesystem:
        directory: /data/loki/chunks
      cassandra:
        username: cassandra
        password: cassandra
        addresses: cassandra
        auth: true
        keyspace: lokiindex
      aws:
        s3: s3://<accessKey>:<secretKey>@<s3_url>/<buckets>
        s3forcepathstyle: true
    

ä¸Šé¢çš„é…ç½®æ„æ€å°±æ˜¯å¯¹äº2022å¹´6æœˆ18æ—¥ä¹‹å‰ä¿å­˜çš„æ‰€æœ‰æ•°æ®ï¼ŒLoki ä½¿ç”¨ `v10` çš„ schemaï¼Œåˆ°ç‚¹ä¹‹åå°±é‡‡ç”¨ `v11` çš„ schema ç­–ç•¥æ¥å­˜å‚¨æ—¥å¿—ã€‚

**cache_config**

`cache_config` å—ç”¨æ¥é…ç½® Loki å°†å¦‚ä½•ç¼“å­˜ requestsã€chunks å’Œç´¢å¼•åˆ°ä¸€ä¸ªåç«¯ç¼“å­˜å­˜å‚¨ä¸­å»ã€‚
    
    
    # å¼€å¯å†…å­˜ç¼“å­˜
    # CLI flag: -<prefix>.cache.enable-fifocache
    [enable_fifocache: <boolean>]
    
    # ç¼“å­˜çš„é»˜è®¤æœ‰æ•ˆæœŸï¼ˆé™¤éé‡å†™ï¼‰ã€‚
    # CLI flag: -<prefix>.default-validity
    [default_validity: <duration>]
    
    # åœ¨ä½¿ç”¨ memcached æ—¶é…ç½®åå°ç¼“å­˜
    background:
      # æœ‰å¤šå°‘ goroutines ç”¨æ¥å†™å› memcachedã€‚
      # CLI flag: -<prefix>.background.write-back-concurrency
      [writeback_goroutines: <int> | default = 10]
    
      # åå°å†™å› memcached éœ€è¦ç¼“å­˜å¤šå°‘ chunksã€‚
      # CLI flagL -<prefix>.background.write-back-buffer
      [writeback_buffer: <int> = 10000]
    
    # é…ç½® memcached
    memcached:
      # é…ç½® memcached ä¸­çš„ key æœ‰æ•ˆæœŸ
      # CLI flag: -<prefix>.memcached.expiration
      expiration: <duration>
    
      # é…ç½®æ¯ä¸ªæ‰¹å¤„ç†è¯·æ±‚ä¸­è¦è·å–çš„ keys æ•°é‡ã€‚
      # CLI flag: -<prefix>.memcached.batchsize
      batch_size: <int> | default = 1024
    
      # å¯¹ memcached çš„æœ€å¤§æ´»åŠ¨è¯·æ±‚æ•°ã€‚
      # CLI flag: -<prefix>.memcached.parallelism
      [parallelism: <int> | default = 100]
    
    # é…ç½®å¦‚ä½•è¿æ¥åˆ°ä¸€ä¸ªæˆ–å¤šä¸ª memcached æœåŠ¡å™¨
    memcached_client:
      # ç¼“å­˜ chunks æ—¶ç”¨äº memcached æœåŠ¡çš„ä¸»æœºåã€‚
      # å¦‚æœä¸ºç©ºï¼Œæ²¡æœ‰ memcached ä¼šè¢«ä½¿ç”¨ã€‚å°†ä½¿ç”¨ SRV æŸ¥æ‰¾ã€‚
      # CLI flag: -<prefix>.memcached.hostname
      [host: <string>]
    
      # ç”¨äºå‘ç° memcached æœåŠ¡å™¨çš„ SRV æœåŠ¡ã€‚
      # CLI flag: -<prefix>.memcached.service
      [service: <string> | default = "memcached"]
    
      # (å®éªŒæ€§çš„) DNS æœåŠ¡å‘ç°åœ°å€åˆ—è¡¨(é€—å·åˆ†éš”)
      # https://cortexmetrics.io/docs/configuration/arguments/#dns-service-discovery
      # CLI flag: -<prefix>.memcached.addresses
      [addresses: <string> | default = ""]
    
      # memcached è¯·æ±‚è¶…æ—¶æ—¶é—´
      # CLI flag: -<prefix>.memcached.timeout
      [timeout: <duration> | default = 100ms]
    
      # memcached å®¢æˆ·ç«¯æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥æ•°ã€‚
      # CLI flag: -<prefix>.memcached.max-idle-conns
      [max_idle_conns: <int> | default = 16]
    
      # è½®è¯¢ memcached æœåŠ¡å™¨çš„ DNS çš„æ—¶é—´é—´éš”ã€‚
      # CLI flag: -<prefix>.memcached.update-interval
      [update_interval: <duration> | default = 1m]
    
      # æ˜¯å¦ä½¿ç”¨ä¸€è‡´å“ˆå¸Œæ¥å‘ç°å¤šä¸ª memcached æœåŠ¡å™¨ã€‚
      # CLI flag: -<prefix>.memcached.consistent-hash
      [consistent_hash: <boolean> | default = true]
    
      # CLI flag: -<prefix>.memcached.max-item-size
      [max_item_size: <int> | default = 0]
      # ...... çœç•¥
    
    redis:
      # ç”¨äºç¼“å­˜çš„ Redis Server æˆ– Cluster é…ç½®
      # CLI flag: -<prefix>.redis.endpoint
      [endpoint: <string>]
      # ...... çœç•¥
    
    fifocache:
      # æœ€å¤§ç¼“å­˜å¤§å°ï¼ˆbytesï¼‰
      # CLI flag: -<prefix>.fifocache.max-size-bytes
      [max_size_bytes: <string> | default = "1GB"]
    
      # æœ€å¤šç¼“å­˜å¤šå°‘ items
      # CLI flag: -<prefix>.fifocache.max-size-items
      [max_size_items: <int> | default = 0]
    
      # ç¼“å­˜æœ‰æ•ˆæœŸ
      # The value of 0 disables auto-expiration.
      # CLI flag: -<prefix>.fifocache.ttl
      [ttl: <duration> | default = 1h]
    

**table_manager**

`Table Manager` æ˜¯ Lokiçš„ä¸€ä¸ªç»„ä»¶ï¼Œä¸»è¦è´Ÿè´£åœ¨å…¶æ—¶é—´æ®µå¼€å§‹ä¹‹å‰åˆ›å»ºå‘¨æœŸè¡¨ï¼Œå¹¶åœ¨å…¶æ•°æ®æ—¶é—´èŒƒå›´è¶…å‡ºä¿ç•™æœŸé™æ—¶å°†å…¶åˆ é™¤ã€‚å®ƒå½“å‰æ”¯æŒçš„åç«¯åŒ…å«å¦‚ä¸‹
    
    
    # ç”¨äºè¡¨å®¹é‡æ›´æ–°çš„ä¸»â€œå…³é—­å¼€å…³â€ï¼Œä¾‹å¦‚æ•…éšœæ’é™¤æ—¶ã€‚
    # CLI flag: -table-manager.throughput-updates-disabled
    [throughput_updates_disabled: <boolean> | default = false]
    
    # ç”¨äºè¡¨ä¿ç•™åˆ é™¤çš„ä¸»å¼€å…³
    # CLI flag: -table-manager.retention-deletes-enabled
    [retention_deletes_enabled: <boolean> | default = false]
    
    # åœ¨åˆ é™¤è¡¨ä¹‹å‰ï¼Œå®ƒä»¬å°†ä¿ç•™å¤šé•¿æ—¶é—´ï¼Œ0sè¡¨ç¤ºç¦ç”¨åˆ é™¤ã€‚
    # ä¿ç•™æœŸå¿…é¡»æ˜¯ index / chunks è¡¨ "period" çš„å€æ•°ã€‚
    # CLI flag: -table-manager.retention-period
    [retention_period: <duration> | default = 0s]
    
    # è¡¨ç®¡ç†å™¨è½®è¯¢è¡¨çš„æ—¶é—´é—´éš”ã€‚
    # CLI flag: -table-manager.poll-interval
    [poll_interval: <duration> | default = 2m]
    
    # åœ¨éœ€è¦åˆ›å»ºè¡¨ä¹‹å‰çš„æŒç»­æ—¶é—´ã€‚
    # CLI flag: -table-manager.periodic-table.grace-period
    [creation_grace_period: <duration> | default = 10m]
    
    # é…ç½® DynamoDB ç´¢å¼•è¡¨ã€‚
    # The CLI flags prefix for this block config is: table-manager.index-table
    index_tables_provisioning: <provision_config>
    
    # é…ç½® DynamoDB chunk è¡¨ã€‚
    # The CLI flags prefix for this block config is: table-manager.chunk-table
    chunk_tables_provisioning: <provision_config>
    

é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŸå§‹æ—¥å¿—æ–‡ä»¶é™¤äº†ä½¿ç”¨ filesystem çš„å­˜å‚¨æœ‰å‘¨æœŸåˆ é™¤æ—§æ—¥å¿—æ–‡ä»¶å¤–ï¼ŒLoki çš„å…¶ä»– chunk å­˜å‚¨å‡ä¸ä¼šåˆ é™¤æ—§æ—¥å¿—æ–‡ä»¶ ï¼Œå¦‚æœä½ çš„æ—¥å¿—åŸå§‹æ–‡ä»¶å­˜å‚¨åœ¨ S3 ä¸Šï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰¾åˆ°æ—§çš„æ–‡ä»¶åˆ é™¤ï¼Œè¿™ä¸ªåŠ¨ä½œä»…ä»…åªä¼šå½±å“æˆ‘ä»¬æŸ¥è¯¢ä¸åˆ°è¿™ä¸ªæ—¶é—´åŒºåŸŸçš„æ—¥å¿—å†…å®¹ã€‚å¦‚æœä½ çš„ Loki å­˜å‚¨ç”¨äº† table-based çš„å­˜å‚¨æœåŠ¡ï¼Œé‚£ä¹ˆæ—¥å¿—çš„ç•™å­˜ç­–ç•¥å°±ä¼šå—åˆ° `Table Manager` çš„èŠ‚åˆ¶ï¼Œå®ƒå½“å‰æ”¯æŒçš„åç«¯åŒ…å«å¦‚ä¸‹ï¼š

  * Index æ—¥å¿—ç´¢å¼•
  * Amazon DynamoDB
  * Google Bigtable
  * Apache Cassandra
  * BoltDB (ä¸»è¦ç”¨äºæœ¬åœ°ç¯å¢ƒ)
  * Chunk æ—¥å¿—åŸå§‹æ–‡ä»¶
  * Amazon DynamoDB
  * Google Bigtable
  * Apache Cassandra
  * Filesystem (ä¸»è¦ç”¨äºæœ¬åœ°ç¯å¢ƒ)



ç”±äºå…·æœ‰ç ´åæ€§ï¼Œé»˜è®¤æƒ…å†µä¸‹ `Table Manager` åŠŸèƒ½è¢«ç¦ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é…ç½®ä¸­æ˜¾å¼å¯ç”¨æ•°æ®åˆ é™¤ç­–ç•¥å¹¶å°†å…¶ä¿ç•™æœŸè®¾ç½®ä¸ºå¤§äº0ã€‚
    
    
    table_manager:
      retention_deletes_enabled: true
      retention_period: 336h
    
